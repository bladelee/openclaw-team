# 最终用户需求支持度分析

> 日期: 2026-02-06
> 目的: 分析当前 Web UI 对最终用户需求的可用性

---

## 最终用户需求

1. **用户登录系统** - 通过账号密码或 OAuth (Google/GitHub) 登录
2. **创建 OpenClaw 实例** - 登录后创建自己的 AI 助手实例
3. **管理实例** - 查看、重启、删除自己的实例
4. **访问实例** - 通过 URL 访问自己的 OpenClaw 助手

---

## 功能支持度分析

### ✅ 完全支持的功能

| 功能 | 状态 | 说明 |
|------|------|------|
| **创建实例** | ✅ | API 完整实现，前端 UI 可用 |
| **查看实例** | ✅ | 显示实例列表、状态、URL |
| **重启实例** | ✅ | 一键重启功能 |
| **删除实例** | ✅ | 带确认对话框的删除功能 |
| **访问实例** | ✅ | 点击打开新标签页访问 |
| **查看主机监控** | ✅ | 查看所有主机状态和资源使用 |

### ⚠️ 部分支持的功能

| 功能 | 状态 | 限制 | 影响 |
|------|------|------|------|
| **登录 - 简化密码** | ⚠️ | 没有真实密码验证，任何密码都能登录 | **仅开发测试可用** |
| **登录 - Shared Secret** | ✅ | 完整实现，适合 SSO 集成 | 需要预先生成签名 |
| **多实例管理** | ⚠️ | 当前限制一用户一实例 | 数据库有 UNIQUE 约束 |

### ❌ 不支持的功能

| 功能 | 状态 | 缺失内容 |
|------|------|----------|
| **OAuth 2.0 登录** | ❌ | Better-auth/Casdoor 集成未实现 |
| **用户注册** | ❌ | 没有注册流程 |
| **密码管理** | ❌ | 没有修改密码功能 |
| **用户资料** | ❌ | 没有用户资料管理 |

---

## 可直接使用的场景

### 场景 1: 内部测试 / 早期试用

**前提条件:**
- 使用开发模式登录（Shared Secret）
- 用户数量少，可控
- 不需要真实的 OAuth 认证

**用户流程:**
```
1. 访问 Web UI
2. 点击"进入仪表板"
3. 在登录页选择"开发"标签
4. 输入用户 ID 和邮箱（或使用默认值）
5. 点击"一键登录并创建实例"
6. 成功！看到自己的 OpenClaw 实例
7. 点击"打开"访问实例
```

**适用性:** ✅ 完全可用

### 场景 2: 与现有 SSO 集成 (Better-auth/Casdoor)

**前提条件:**
- 已有 Better-auth 或 Casdoor 服务器
- 技术团队可以集成 Shared Secret 认证

**集成方案:**
```
现有 SSO (Next.js)
    │
    │ 生成签名
    ▼
┌─────────────────────────────────────────┐
│  前端: 调用 /api/auth/signature/:userId    │
└─────────────────────────────────────────┘
    │
    │ 使用签名 + 用户信息
    ▼
┌─────────────────────────────────────────┐
│  租户管理 API: 验证签名并创建租户        │
└─────────────────────────────────────────┘
```

**前端集成代码:**
```typescript
// 在您的 Next.js 应用中
async function createOpenClawInstance(userId: string, email: string) {
  // 1. 从租户管理 API 获取签名
  const sigResponse = await fetch('http://tenant-manager/api/auth/signature/' + userId);
  const { signature } = await sigResponse.json();

  // 2. 使用签名创建租户
  const response = await fetch('http://tenant-manager/api/tenants', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-User-ID': userId,
      'X-User-Email': email,
      'X-User-Signature': signature,
    },
    body: JSON.stringify({ email, plan: 'basic' }),
  });

  return await response.json();
}
```

**适用性:** ✅ 需要 SSO 端集成，但功能完整

### 场景 3: 独立部署（需要额外开发）

**缺失内容:**
1. 用户注册系统
2. 真实密码哈希存储
3. OAuth 2.0 流程

**额外开发工作量:** 中等（2-3 天）

---

## 当前限制

### 数据库限制

```sql
-- tenants 表有 UNIQUE 约束
UNIQUE(user_id)  -- 一个用户只能有一个租户
```

**影响:** 如果用户想创建多个实例，会收到错误。

**解决方案:** 修改数据库结构，允许一用户多租户。

### 认证限制

当前登录实现（routes.ts 第 17-43 行）:
```typescript
// TODO: 实现真实的密码验证
// 目前简化为直接生成 token
const userId = email.split('@')[0]; // 简化处理

const token = generateToken({
  userId,
  email,
  plan: 'basic',
});
```

**影响:** 任何密码都能登录任何邮箱账号。

**解决方案:** 实现真实的用户表和密码验证。

---

## 启动测试环境

### 环境要求检查

- [ ] Node.js 18+ 已安装
- [ ] pnpm 已安装
- [ ] PostgreSQL 数据库运行中
- [ ] Portainer 已配置（可选，用于真实容器创建）

### 启动命令

我将启动两个服务：
1. 租户管理 API 服务
2. 前端 Web UI

---

## 总结

### 当前可用功能（最终用户可直接用）

| 功能 | 可用性 | 备注 |
|------|--------|------|
| 登录（开发模式） | ✅ | Shared Secret 快速登录 |
| 创建实例 | ✅ | 完整功能 |
| 查看实例 | ✅ | 完整功能 |
| 重启实例 | ✅ | 完整功能 |
| 删除实例 | ✅ | 完整功能 |
| 访问实例 | ✅ | 通过 URL 直接访问 |
| 主机监控 | ✅ | 查看系统状态 |

### 需要额外开发的功能

| 功能 | 优先级 | 工作量 |
|------|--------|--------|
| OAuth 2.0 集成 | P0 | 2-3 天 |
| 用户注册 | P1 | 1 天 |
| 真实密码验证 | P1 | 1 天 |
| 多实例支持 | P2 | 0.5 天 |

### 推荐部署方式

**方式 1: 内部测试（当前可用）**
- 使用开发模式登录
- 快速验证功能
- 适合团队内部试用

**方式 2: SSO 集成（需要集成工作）**
- 将 Web UI 嵌入到现有 Next.js 应用
- 使用 Shared Secret 认证
- 适合有现有 SSO 的场景

**方式 3: 独立产品（需要开发）**
- 实现完整的用户系统
- OAuth 2.0 登录
- 适合作为独立产品发布
