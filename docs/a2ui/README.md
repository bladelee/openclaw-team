# A2UI OpenClaw æ–‡æ¡£ä¸­å¿ƒ

æœ¬æ–‡æ¡£ç´¢å¼•æ±‡æ€»äº† OpenClaw åœ¨ Web/H5 å¤šç”¨æˆ·äº‘ç«¯éƒ¨ç½²åœºæ™¯ä¸‹çš„å®Œæ•´æŠ€æœ¯æ–¹æ¡ˆã€‚

## å¿«é€Ÿå¯¼èˆª

### ğŸš€ å¿«é€Ÿå¼€å§‹ï¼ˆæ¨èé˜…è¯»é¡ºåºï¼‰

```
1. [é—®é¢˜è¯Šæ–­] â†’ chat-history-timing-issue.md
2. [å‚è€ƒå®ç°] â†’ web-ui-chat-implementation-analysis.md
3. [è®¤è¯æœºåˆ¶] â†’ openclaw-native-auth-mechanisms.md
4. [éƒ¨ç½²æ–¹æ¡ˆ] â†’ deployment-authentication-solutions-refined.md
5. [æœ€ç»ˆæ–¹æ¡ˆ] â†’ sso-multi-user-implementation-guide.md â­
```

---

## ğŸ“š æ–‡æ¡£åˆ†ç±»

### ä¸€ã€é—®é¢˜åˆ†æä¸è§£å†³æ–¹æ¡ˆ

#### 1.1 Chat å†å²è®°å½•æ—¶åºé—®é¢˜

**æ–‡æ¡£**: `chat-history-timing-issue.md`

**ç®€ä»‹**: åˆ†æäº† chat.send çš„ final äº‹ä»¶ä¸ chat.history å“åº”ä¹‹é—´çš„æ—¶åºç«äº‰é—®é¢˜ã€‚Gateway çš„å¼‚æ­¥æ¶ˆæ¯å†™å…¥å‘ç”Ÿåœ¨ final äº‹ä»¶ä¹‹åï¼Œå¯¼è‡´å®¢æˆ·ç«¯ç«‹å³è¯·æ±‚å†å²æ—¶è·å–ä¸åˆ°æœ€æ–°æ¶ˆæ¯ã€‚

**æ ¸å¿ƒé—®é¢˜**:
- Gateway å¼‚æ­¥å†™å…¥ session æ–‡ä»¶ï¼ˆfinal äº‹ä»¶ä¹‹åï¼‰
- å®¢æˆ·ç«¯ç«‹å³è¯·æ±‚ historyï¼ˆè·å–ä¸åˆ°æœ€æ–°æ¶ˆæ¯ï¼‰
- æ—¶åºå·®ï¼š~100-500ms

**è§£å†³æ–¹æ¡ˆ**:
1. **æ–¹æ¡ˆ Aï¼ˆæ¨èï¼‰**: ä½¿ç”¨ `payload.message` è€Œé history
2. **æ–¹æ¡ˆ B**: æ·»åŠ  300-500ms å»¶è¿Ÿåå†è¯·æ±‚ history
3. **æ–¹æ¡ˆ C**: ä¸è¯·æ±‚ historyï¼Œä¾èµ–æœ¬åœ°ç´¯ç§¯

**é€‚ç”¨åœºæ™¯**: H5/Web å®¢æˆ·ç«¯å¼€å‘

**ç›¸å…³æ–‡ä»¶**:
- `src/canvas-host/app-h5/services/chat/ChatService.ts`

---

#### 1.2 Web UI Chat å®ç°åˆ†æ

**æ–‡æ¡£**: `web-ui-chat-implementation-analysis.md`

**ç®€ä»‹**: è¯¦ç»†åˆ†æäº† OpenClaw Web UI çš„ Chat åŠŸèƒ½å®ç°ï¼Œä¸º H5 å¼€å‘æä¾›å‚è€ƒã€‚

**æ ¸å¿ƒå†…å®¹**:
- **åè®®å¤„ç†**: WebSocket Gateway Protocol v3ï¼Œå¸§æ ¼å¼ï¼ˆreq/res/eventï¼‰
- **çŠ¶æ€ç®¡ç†**: React hooksï¼Œæ¶ˆæ¯é˜Ÿåˆ—ï¼Œdelta å¤„ç†ï¼ˆæ›¿æ¢æ¨¡å¼ï¼‰
- **æµç¨‹å›¾**:
  - ç”¨æˆ·å‘é€æ¶ˆæ¯ â†’ chat.send â†’ Agent æ‰§è¡Œ â†’ delta äº‹ä»¶æµ â†’ final äº‹ä»¶
  - history è¯·æ±‚ â†’ chat.history â†’ è¿”å›å®Œæ•´å†å²

**å…³é”®å‘ç°**:
- Delta å¤„ç†ï¼š**æ›¿æ¢æ¨¡å¼**ï¼ˆè€Œéç´¯ç§¯æ¨¡å¼ï¼‰
- `message.content` åœ¨ delta äº‹ä»¶ä¸­æ˜¯å®Œæ•´å†…å®¹ï¼Œä¸æ˜¯å¢é‡
- `payload.message` åœ¨ final äº‹ä»¶ä¸­åŒ…å«å®Œæ•´å“åº”

**é€‚ç”¨åœºæ™¯**: H5 å®¢æˆ·ç«¯å¼€å‘å‚è€ƒ

**ç›¸å…³æ–‡ä»¶**:
- `src/canvas-host/app-web/src/components/chat/` (å‚è€ƒå®ç°)

---

#### 1.3 åµŒå…¥ Web UI Chat æ–¹æ¡ˆ

**æ–‡æ¡£**: `embedding-web-ui-chat-solutions.md`

**ç®€ä»‹**: æä¾› 5 ç§åœ¨è‡ªå®šä¹‰ Web åº”ç”¨ä¸­åµŒå…¥ OpenClaw Chat åŠŸèƒ½çš„æ–¹æ¡ˆã€‚

**æ–¹æ¡ˆå¯¹æ¯”**:

| æ–¹æ¡ˆ | å¤æ‚åº¦ | çµæ´»æ€§ | æ¨èåº¦ |
|------|--------|--------|--------|
| 1. iframe | âš ï¸ ä½ | âš ï¸ ä¸­ | âš ï¸ å¿«é€ŸåŸå‹ |
| 2. Web Components | âš ï¸ ä¸­ | âœ… é«˜ | âœ… **æ¨èç”Ÿäº§** |
| 3. React ç»„ä»¶é›†æˆ | âŒ é«˜ | âœ… é«˜ | âœ… React é¡¹ç›® |
| 4. ç›´æ¥ API é›†æˆ | âŒ é«˜ | âœ… æœ€é«˜ | âš ï¸ å®Œå…¨è‡ªå®šä¹‰ |
| 5. å¾®å‰ç«¯ | âŒ é«˜ | âœ… é«˜ | âš ï¸ å¤§å‹é¡¹ç›® |

**æ¨è**: Web Componentsï¼ˆå¹³è¡¡å¤æ‚åº¦å’Œçµæ´»æ€§ï¼‰

**é€‚ç”¨åœºæ™¯**: éœ€è¦åœ¨ç°æœ‰ Web åº”ç”¨ä¸­é›†æˆ OpenClaw Chat

---

### äºŒã€è®¤è¯ä¸æˆæƒæœºåˆ¶

#### 2.1 OpenClaw åŸç”Ÿè®¤è¯æœºåˆ¶

**æ–‡æ¡£**: `openclaw-native-auth-mechanisms.md`

**ç®€ä»‹**: è¯¦ç»†ä»‹ç» OpenClaw åŸç”Ÿæ”¯æŒçš„ 4 ç§è®¤è¯æ–¹å¼ã€‚

**è®¤è¯æ¨¡å¼å¯¹æ¯”**:

| æ¨¡å¼ | å®‰å…¨æ€§ | å®ç°å¤æ‚åº¦ | å¤šç”¨æˆ·æ”¯æŒ | æ¨èåœºæ™¯ |
|------|--------|-----------|-----------|----------|
| **Tokenï¼ˆå…±äº«ï¼‰** | âŒ ä½ | âœ… ç®€å• | âŒ ä¸æ”¯æŒ | ä¸ªäººä½¿ç”¨ |
| **Password** | âš ï¸ ä¸­ä½ | âœ… ç®€å• | âŒ ä¸æ”¯æŒ | ä¸ªäººä½¿ç”¨ |
| **Tailscale** | âœ… ä¸­é«˜ | âœ… ç®€å• | âŒ ä¸æ”¯æŒ | å†…ç½‘/è¾¹ç¼˜ |
| **è®¾å¤‡é…å¯¹ + deviceToken** | âœ… ä¸­é«˜ | âœ… ç®€å• | âš ï¸ éœ€å¤„ç† | âœ… **æ¨è** |

**è®¾å¤‡é…å¯¹æµç¨‹**:
1. å®¢æˆ·ç«¯ç”Ÿæˆ Ed25519 å¯†é’¥å¯¹
2. å‘é€ connect è¯·æ±‚ï¼ˆå«ç­¾åï¼‰
3. Gateway åˆ›å»ºé…å¯¹è¯·æ±‚ï¼ˆpendingï¼‰
4. ç”¨æˆ·åœ¨ Control UI æ‰¹å‡†
5. Gateway ç”Ÿæˆ deviceToken
6. åç»­è¿æ¥ä½¿ç”¨ deviceToken

**å­˜å‚¨ä½ç½®**:
- `~/.openclaw/devices/paired.json` - å·²é…å¯¹è®¾å¤‡
- `~/.openclaw/devices/pending.json` - å¾…é…å¯¹è¯·æ±‚

**é€‚ç”¨åœºæ™¯**: äº†è§£ OpenClaw è®¤è¯èƒ½åŠ›

**ç›¸å…³æ–‡ä»¶**:
- `src/gateway/auth.ts`
- `src/infra/device-pairing.ts`

---

#### 2.2 OAuth + Password è®¤è¯æ–¹æ¡ˆ

**æ–‡æ¡£**: `oauth-password-auth-solution.md`

**ç®€ä»‹**: ç»“åˆ OAuth 2.0 SSO ä¸ Password æ¨¡å¼çš„æ··åˆè®¤è¯æ–¹æ¡ˆã€‚

**æ¶æ„**:
```
Layer 1: OAuth 2.0ï¼ˆç³»ç»Ÿçº§è®¤è¯ï¼‰
  â””â”€ ç”¨äºæ‰€æœ‰åŠŸèƒ½çš„ç”¨æˆ·èº«ä»½éªŒè¯

Layer 2: Password æ¨¡å¼ï¼ˆOpenClaw ä¸“ç”¨ï¼‰
  â””â”€ æ¯ä¸ªç”¨æˆ·åŠ¨æ€ç”Ÿæˆä¸“å±å¯†ç 

Layer 3: sessionKeyï¼ˆç”¨æˆ·éš”ç¦»ï¼‰
  â””â”€ æ¯ä¸ªç”¨æˆ·ç‹¬ç«‹ä¼šè¯
```

**æ ¸å¿ƒæµç¨‹**:
1. ç”¨æˆ· OAuth ç™»å½• â†’ è·å¾— `user_id`
2. API Gateway æŸ¥è¯¢/ç”Ÿæˆç”¨æˆ·ä¸“å±å¯†ç 
3. å‰ç«¯ä½¿ç”¨å¯†ç è¿æ¥ Gateway
4. Gateway ä½¿ç”¨ `sessionKey: "user:{user_id}"` éš”ç¦»

**ä¼˜åŠ¿**:
- âœ… æ¯”å…±äº« Token å®‰å…¨
- âœ… æ¯”è®¾å¤‡é…å¯¹ç®€å•
- âœ… æ˜“äºä¸ OAuth é›†æˆ

**é€‚ç”¨åœºæ™¯**: å·²æœ‰ OAuth ç³»ç»Ÿçš„é›†æˆ

---

#### 2.3 OAuth + è®¾å¤‡ç­¾åæ··åˆæ–¹æ¡ˆ

**æ–‡æ¡£**: `oauth-device-hybrid-auth-solution.md`

**ç®€ä»‹**: OAuth 2.0ï¼ˆç”¨æˆ·èº«ä»½ï¼‰+ è®¾å¤‡ç­¾åï¼ˆè®¾å¤‡èº«ä»½ï¼‰çš„åŒé‡è®¤è¯ã€‚

**æ¶æ„**:
```
Layer 1: OAuth 2.0
  â””â”€ éªŒè¯ç”¨æˆ·èº«ä»½ï¼ˆuser_id, emailï¼‰

Layer 2: è®¾å¤‡ç­¾å
  â””â”€ éªŒè¯è®¾å¤‡èº«ä»½ï¼ˆdeviceId, signatureï¼‰

Layer 3: sessionKey
  â””â”€ ç”¨æˆ·ä¼šè¯éš”ç¦»
```

**è®¤è¯æµç¨‹**:
1. ç”¨æˆ· OAuth ç™»å½•
2. å®¢æˆ·ç«¯ç”Ÿæˆè®¾å¤‡ç­¾åï¼ˆEd25519ï¼‰
3. å‘é€ connect è¯·æ±‚ï¼š
   - OAuth Tokenï¼ˆç”¨æˆ·èº«ä»½ï¼‰
   - è®¾å¤‡ç­¾åï¼ˆè®¾å¤‡èº«ä»½ï¼‰
4. Gateway åŒé‡éªŒè¯

**ä¼˜åŠ¿**:
- âœ… ç”¨æˆ·çº§ + è®¾å¤‡çº§åŒé‡å®‰å…¨
- âœ… è®¾å¤‡æ’¤é”€ä¸å½±å“å…¶ä»–è®¾å¤‡

**åŠ£åŠ¿**:
- âŒ å®ç°å¤æ‚åº¦é«˜
- âŒ éœ€è¦ç®¡ç†å¯†é’¥å¯¹

**é€‚ç”¨åœºæ™¯**: é«˜å®‰å…¨è¦æ±‚åœºæ™¯

---

### ä¸‰ã€éƒ¨ç½²æ¶æ„æ–¹æ¡ˆ

#### 3.1 éƒ¨ç½²ä¸è®¤è¯æ–¹æ¡ˆï¼ˆåˆå§‹ç‰ˆï¼‰

**æ–‡æ¡£**: `deployment-authentication-solutions.md`

**ç®€ä»‹**: æä¾› 5 ç§äº‘ç«¯éƒ¨ç½² + æœ¬åœ°ç¡¬ä»¶ç›’å­çš„è®¤è¯æ–¹æ¡ˆã€‚

**æ–¹æ¡ˆæ€»è§ˆ**:

| æ–¹æ¡ˆ | è®¤è¯æ–¹å¼ | é€‚ç”¨åœºæ™¯ | å¤šç”¨æˆ· |
|------|---------|---------|--------|
| **æ–¹æ¡ˆ 1** | å…±äº« Token | ä¸ªäººä½¿ç”¨ | âŒ |
| **æ–¹æ¡ˆ 2** | è®¾å¤‡ç­¾å | æœ¬åœ°ç›’å­ | âš ï¸ éœ€å¤„ç† |
| **æ–¹æ¡ˆ 3** | OAuth 2.0 | äº‘ç«¯å¤šç§Ÿæˆ· | âœ… |
| **æ–¹æ¡ˆ 4** | è®¾å¤‡é…å¯¹ | å†…ç½‘ | âš ï¸ éœ€å¤„ç† |
| **æ–¹æ¡ˆ 5** | Tailscale | è¾¹ç¼˜è®¡ç®— | âŒ |

**æ ¸å¿ƒå‘ç°**:
- Agent åµŒå…¥åœ¨ Gateway è¿›ç¨‹ä¸­ï¼ˆéç‹¬ç«‹è¿›ç¨‹ï¼‰
- `sessionKey` æä¾›é€»è¾‘éš”ç¦»
- Gateway æ”¯æŒæ°´å¹³æ‰©å±•

**é€‚ç”¨åœºæ™¯**: äº†è§£æ‰€æœ‰éƒ¨ç½²é€‰é¡¹

---

#### 3.2 éƒ¨ç½²ä¸è®¤è¯æ–¹æ¡ˆï¼ˆç²¾ç‚¼ç‰ˆï¼‰

**æ–‡æ¡£**: `deployment-authentication-solutions-refined.md`

**ç®€ä»‹**: ä¸“æ³¨äºæ–¹æ¡ˆ 2ï¼ˆè®¾å¤‡ç­¾åï¼‰å’Œæ–¹æ¡ˆ 3ï¼ˆOAuth 2.0ï¼‰ï¼Œé’ˆå¯¹ä¸šåŠ¡éœ€æ±‚ç»†åŒ–ã€‚

**ä¸šåŠ¡éœ€æ±‚**:
- é€šè¿‡å…¬ç½‘äº‘ç«¯æ§åˆ¶äº‘ç«¯ Docker + æœ¬åœ°ç¡¬ä»¶ç›’å­
- ç”¨æˆ·ä¹‹é—´å®Œå…¨éš”ç¦»
- ç»Ÿä¸€ Web/H5 è®¿é—®

**æ–¹æ¡ˆ 2: è®¾å¤‡ç­¾åï¼ˆæœ¬åœ°ç›’å­ä¸“ç”¨ï¼‰**

æµç¨‹ï¼š
1. ç”¨æˆ· OAuth ç™»å½•
2. å‰ç«¯è°ƒç”¨ `/api/boxes/{boxId}/pair-token`
3. è¿”å›ä¸€æ¬¡æ€§é…å¯¹ Token
4. æœ¬åœ°ç›’å­ä½¿ç”¨é…å¯¹ Token æ³¨å†Œ
5. åç»­ä½¿ç”¨ deviceToken è¿æ¥

**æ–¹æ¡ˆ 3: OAuth 2.0ï¼ˆäº‘ç«¯ä¸“ç”¨ï¼‰**

æµç¨‹ï¼š
1. ç”¨æˆ· OAuth ç™»å½•
2. å‰ç«¯è°ƒç”¨ `/api/openclaw/credentials`
3. è¿”å› Gateway URL + Passwordï¼ˆåŠ¨æ€ç”Ÿæˆï¼‰
4. è¿æ¥å¹¶ä½¿ç”¨ `sessionKey: "user:{user_id}"`

**ç»Ÿä¸€è®¿é—®å±‚**:
```
ç”¨æˆ·æµè§ˆå™¨
  â”œâ”€ OAuth 2.0 ç™»å½•
  â”œâ”€ äº‘ç«¯ Gateway â†’ OAuth + Password + sessionKey
  â””â”€ æœ¬åœ°ç›’å­ â†’ OAuth + ä¸€æ¬¡æ€§é…å¯¹ Token + deviceToken
```

**é€‚ç”¨åœºæ™¯**: äº‘ç«¯ + æœ¬åœ°ç›’å­æ··åˆéƒ¨ç½²

---

#### 3.3 OpenClaw æ²™ç›’ä¸è®¾å¤‡è®¤è¯è¯¦æƒ…

**æ–‡æ¡£**: `openclaw-sandbox-and-device-auth-details.md`

**ç®€ä»‹**: è¯¦ç»†è§£é‡Š OpenClaw ä¸­å“ªäº›ç»„ä»¶è¿è¡Œåœ¨æ²™ç›’/Docker ä¸­ï¼Œä»¥åŠè®¾å¤‡è®¤è¯çš„å®Œæ•´æµç¨‹ã€‚

**æ²™ç›’æœºåˆ¶**:

| ç»„ä»¶ | è¿è¡Œä½ç½® | éš”ç¦»çº§åˆ« |
|------|---------|---------|
| **Gateway** | ä¸»æœºè¿›ç¨‹ | æ— éš”ç¦» |
| **Agent (pi-ai SDK)** | åµŒå…¥åœ¨ Gateway è¿›ç¨‹ä¸­ | é€»è¾‘éš”ç¦»ï¼ˆsessionKeyï¼‰ |
| **å·¥å…·æ‰§è¡Œï¼ˆPythonï¼‰** | Docker æ²™ç›’ | å®¹å™¨éš”ç¦» |
| **æµè§ˆå™¨æ§åˆ¶** | Browser Sandbox | è¿›ç¨‹éš”ç¦» |
| **æ–‡ä»¶ç³»ç»Ÿè®¿é—®** | å·¥ä½œåŒºï¼ˆworkspaceDirï¼‰ | ç›®å½•éš”ç¦» |

**è®¾å¤‡è®¤è¯å®Œæ•´æµç¨‹**:

```
1. è®¾å¤‡ç”Ÿæˆ Ed25519 å¯†é’¥å¯¹
   â”œâ”€ privateKey: ä¿å­˜åœ¨è®¾å¤‡æœ¬åœ°
   â”œâ”€ publicKey: å‘é€ç»™ Gateway
   â””â”€ deviceId: SHA-256(publicKey)

2. æ„å»º payload
   â”œâ”€ v1: version|deviceId|clientId|clientMode|role|scopes|signedAtMs|token
   â””â”€ v2: + nonce

3. ç­¾å
   â””â”€ signature = sign(privateKey, payload)

4. å‘é€ connect è¯·æ±‚
   â”œâ”€ device.id
   â”œâ”€ device.publicKey
   â”œâ”€ device.signature
   â””â”€ auth.tokenï¼ˆå¯é€‰ï¼‰

5. Gateway éªŒè¯
   â”œâ”€ éªŒè¯ç­¾åæœ‰æ•ˆæ€§
   â”œâ”€ æ£€æŸ¥æ—¶é—´æˆ³ï¼ˆ10 åˆ†é’Ÿå†…ï¼‰
   â””â”€ æ£€æŸ¥ nonceï¼ˆv2 å¿…éœ€ï¼‰
```

**é€‚ç”¨åœºæ™¯**: æ·±å…¥ç†è§£ OpenClaw æ¶æ„

**ç›¸å…³æ–‡ä»¶**:
- `src/infra/device-identity.ts`
- `src/agents/sandbox/context.ts`

---

### å››ã€å¤šç”¨æˆ·éš”ç¦»ä¸è®¡è´¹

#### 4.1 å¤šç”¨æˆ·éš”ç¦»è§£å†³æ–¹æ¡ˆ

**æ–‡æ¡£**: `multi-user-isolation-solutions.md`

**ç®€ä»‹**: æä¾› 5 ç§å¤šç”¨æˆ·å…±äº« Gateway å®ä¾‹æ—¶çš„éš”ç¦»æ–¹æ¡ˆã€‚

**æ–¹æ¡ˆå¯¹æ¯”**:

| æ–¹æ¡ˆ | éš”ç¦»çº§åˆ« | å¤æ‚åº¦ | æ¨èåº¦ |
|------|---------|--------|--------|
| **1. ç‹¬ç«‹å·¥ä½œåŒº** | âœ… æ–‡ä»¶ç³»ç»Ÿ | âš ï¸ ä½ | âœ… **æ¨è** |
| **2. ç‹¬ç«‹å®¹å™¨** | âœ… è¿›ç¨‹çº§ | âŒ é«˜ | âš ï¸ é«˜éš”ç¦»è¦æ±‚ |
| **3. æ•°æ®åº“è·¯ç”±** | âš ï¸ é€»è¾‘çº§ | âš ï¸ ä¸­ | âŒ éœ€å¤§é‡æ”¹é€  |
| **4. å‘½åç©ºé—´éš”ç¦»** | âœ… è¿›ç¨‹çº§ | âŒ é«˜ | âŒ Kubernetes ç¯å¢ƒ |
| **5. Gateway å¤šå®ä¾‹** | âœ… è¿›ç¨‹çº§ | âš ï¸ ä¸­ | âœ… **æ¨è** |

**æ¨èæ–¹æ¡ˆ 1: ç‹¬ç«‹å·¥ä½œåŒº**

å®ç°ï¼š
- æ¯ä¸ªç”¨æˆ·ç‹¬ç«‹ `workspaceDir`: `/data/openclaw-users/{userId}/`
- ä½¿ç”¨ `sessionKey: "user:{userId}"` éš”ç¦»æ¶ˆæ¯é˜Ÿåˆ—
- å¯é€‰ï¼šæ¯ä¸ªç”¨æˆ·ç‹¬ç«‹ `authProfileId`ï¼ˆAPI Tokenï¼‰

**ä¼˜åŠ¿**:
- âœ… æœ€å° OpenClaw æ”¹é€ 
- âœ… æ–‡ä»¶ç³»ç»Ÿå®Œå…¨éš”ç¦»
- âœ… æ¶ˆæ¯é˜Ÿåˆ—é€»è¾‘éš”ç¦»

**é€‚ç”¨åœºæ™¯**: å¤šç”¨æˆ·å…±äº« Gateway å®ä¾‹

---

#### 4.2 API Token ä½¿ç”¨è¿½è¸ªä¸æ€§èƒ½

**æ–‡æ¡£**: `api-token-usage-tracking-performance.md`

**ç®€ä»‹**: è¯¦ç»†è®¾è®¡ç‹¬ç«‹ API Token ç³»ç»Ÿã€ä½¿ç”¨è¿½è¸ªã€è®¡è´¹å’Œ Gateway æ€§èƒ½åˆ†æã€‚

**æ ¸å¿ƒå†…å®¹**:

**1. ç‹¬ç«‹ API Token å®ç°**

å­˜å‚¨ï¼š
```sql
CREATE TABLE user_api_keys (
  user_id VARCHAR(255),
  api_key_encrypted TEXT,  -- AES-256 åŠ å¯†
  provider VARCHAR(50),    -- anthropic, openai
  created_at TIMESTAMP
);
```

**2. Token ä½¿ç”¨è¿½è¸ª**

æ•°æ®åº“è®¾è®¡ï¼š
```sql
CREATE TABLE token_usage_logs (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  user_id VARCHAR(255),
  session_key VARCHAR(255),
  provider VARCHAR(50),
  model VARCHAR(100),
  tokens_input INT,
  tokens_output INT,
  tokens_total INT,
  cost_usd DECIMAL(10, 6),
  timestamp TIMESTAMP
);
```

**3. Gateway æ€§èƒ½åˆ†æ**

| æŒ‡æ ‡ | å•å®ä¾‹ | é›†ç¾¤ï¼ˆ3å®ä¾‹ï¼‰ |
|------|--------|--------------|
| **å¹¶å‘ç”¨æˆ·** | ~100-200 | ~300-600 |
| **å†…å­˜** | 10-20GB | 30-60GB |
| **CPU** | 4-8 æ ¸ | 12-24 æ ¸ |
| **æ°´å¹³æ‰©å±•** | âœ… æ”¯æŒ | âœ… æ”¯æŒ |

**ç“¶é¢ˆåˆ†æ**:
- âš ï¸ Agent æ‰§è¡Œæ˜¯åŒæ­¥çš„ï¼ˆå•çº¿ç¨‹äº‹ä»¶å¾ªç¯ï¼‰
- âœ… å¯é€šè¿‡è´Ÿè½½å‡è¡¡æ°´å¹³æ‰©å±•
- âœ… sessionKey æä¾›å¹¶å‘é˜Ÿåˆ—éš”ç¦»

**è´Ÿè½½å‡è¡¡é…ç½®**:
```nginx
upstream openclaw_gateways {
    least_conn;  # æœ€å°‘è¿æ¥è´Ÿè½½å‡è¡¡
    server gateway-1:19001;
    server gateway-2:19002;
    server gateway-3:19003;
}
```

**é€‚ç”¨åœºæ™¯**: å¤šç”¨æˆ·è®¡è´¹å’Œæ€§èƒ½è§„åˆ’

---

### äº”ã€ç»¼åˆå®æ–½æ–¹æ¡ˆ

#### 5.1 SSO å¤šç”¨æˆ·å®Œæ•´å®æ–½æŒ‡å— â­

**æ–‡æ¡£**: `sso-multi-user-implementation-guide.md`

**ç®€ä»‹**: ç»¼åˆæ‰€æœ‰æ–¹æ¡ˆçš„å®Œæ•´å®æ–½è®¾è®¡ï¼Œç»“åˆ SSO/OAuth + ç‹¬ç«‹å·¥ä½œåŒº + sessionKey + å¯é€‰æ²™ç›’ + æŒ‰ç”¨æˆ·è®¡è´¹ã€‚

**æ¶æ„å›¾**:
```
ç”¨æˆ·æµè§ˆå™¨ (Web/H5)
  â”‚
  â”œâ”€ OAuth 2.0 ç™»å½• (Auth0/Okta/GitHub)
  â”‚
  â”œâ”€ API Gateway + ä¸­é—´ä»¶å±‚
  â”‚   â”œâ”€ SSO è®¤è¯ä¸­é—´ä»¶
  â”‚   â”œâ”€ ç”¨æˆ·ç¯å¢ƒç®¡ç†å™¨
  â”‚   â”œâ”€ è¿æ¥è·¯ç”±å™¨ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰
  â”‚   â””â”€ è®¡è´¹æœåŠ¡
  â”‚
  â””â”€ Gateway é›†ç¾¤
      â”œâ”€ äº‘ç«¯ï¼š3+ å®ä¾‹ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰
      â””â”€ æœ¬åœ°ï¼šTailscale éš§é“
```

**æ ¸å¿ƒåŠŸèƒ½**:

**1. æ•°æ®åº“è®¾è®¡ï¼ˆ7 å¼ è¡¨ï¼‰**
- `oauth_users` - OAuth ç”¨æˆ·
- `user_openclaw_environments` - ç”¨æˆ·ç¯å¢ƒé…ç½®
- `token_usage_logs` - Token ä½¿ç”¨è®°å½•
- `user_quotas` - ç”¨æˆ·é…é¢
- `quota_alerts` - é…é¢å‘Šè­¦
- `user_environment_snapshots` - ç¯å¢ƒå¿«ç…§

**2. OpenClaw æ”¹é€ ï¼ˆ5 ä¸ªæ”¹é€ ç‚¹ï¼‰**

| æ”¹é€ ç‚¹ | æ–‡ä»¶ | å¤æ‚åº¦ |
|--------|------|--------|
| chat.send å‚æ•°æ‰©å±• | `src/gateway/server-methods/chat.ts` | âš ï¸ ä½ |
| ç”¨æˆ·å·¥ä½œåŒºè§£æ | `src/gateway/server-methods/user-workspace.ts` | âš ï¸ ä½ |
| ç”¨æˆ· API Key è§£æ | `src/gateway/server-methods/user-api-key.ts` | âš ï¸ ä½ |
| Token ä½¿ç”¨è®°å½• | `src/gateway/server-methods/usage-tracking.ts` | âš ï¸ ä½ |
| é…é¢æ£€æŸ¥ä¸­é—´ä»¶ | `src/gateway/middleware/quota-check.ts` | âš ï¸ ä¸­ |

**3. æœåŠ¡å±‚å®ç°**

å®Œæ•´çš„ `UserEnvironmentManager` ç±»ï¼š
- åˆå§‹åŒ–ç”¨æˆ·ç¯å¢ƒ
- åˆ›å»ºå·¥ä½œåŒº
- åˆ†é… API Key
- è®¾ç½®é…é¢
- è®°å½•ä½¿ç”¨

**4. éƒ¨ç½²æ–¹æ¡ˆ**

Docker Compose åŒ…å«ï¼š
- PostgreSQL + Redis
- API Gatewayï¼ˆOAuth ä¸­é—´ä»¶ï¼‰
- 3 ä¸ª Gateway å®ä¾‹
- Nginx è´Ÿè½½å‡è¡¡å™¨
- Prometheus + Grafana ç›‘æ§

**5. å®æ–½è·¯çº¿å›¾ï¼ˆ5 å‘¨ï¼‰**

```
ç¬¬ 1 å‘¨: åŸºç¡€è®¾æ–½ + æ•°æ®åº“
ç¬¬ 2 å‘¨: API Gateway å¼€å‘
ç¬¬ 3 å‘¨: OpenClaw Gateway æ”¹é€ 
ç¬¬ 4 å‘¨: é›†æˆæµ‹è¯• + éƒ¨ç½²
ç¬¬ 5 å‘¨: ç›‘æ§å’Œä¼˜åŒ–
```

**å…³é”®æ”¶ç›Š**:
- âœ… å®Œå…¨éš”ç¦»ï¼šå·¥ä½œåŒºã€æ¶ˆæ¯ã€æ²™ç›’
- âœ… ç²¾ç¡®è®¡è´¹ï¼šæ¯ä¸ªç”¨æˆ·ç‹¬ç«‹çš„ Token æ¶ˆè€—
- âœ… çµæ´»é…é¢ï¼šæ”¯æŒæ¯æ—¥ Token é™åˆ¶ã€æ¯æœˆæˆæœ¬é™åˆ¶
- âœ… å¯æ‰©å±•ï¼šæ”¯æŒå¤šç”¨æˆ·ã€å¤šå®ä¾‹æ°´å¹³æ‰©å±•
- âœ… ç”Ÿäº§å°±ç»ªï¼šç›‘æ§ã€å‘Šè­¦ã€æ—¥å¿—å®Œæ•´

**é€‚ç”¨åœºæ™¯**: **æœ€ç»ˆå®æ–½æ–¹æ¡ˆï¼Œæ¶µç›–æ‰€æœ‰éœ€æ±‚**

---

## ğŸ“– é˜…è¯»æŒ‡å—

### åœºæ™¯ 1: æˆ‘åˆšå¼€å§‹äº†è§£ OpenClawï¼Œæƒ³å¿«é€Ÿä¸Šæ‰‹

**æ¨èé˜…è¯»é¡ºåº**:
1. `openclaw-native-auth-mechanisms.md` - äº†è§£è®¤è¯æœºåˆ¶
2. `web-ui-chat-implementation-analysis.md` - äº†è§£ Chat å®ç°
3. `sso-multi-user-implementation-guide.md` - ç›´æ¥çœ‹æœ€ç»ˆæ–¹æ¡ˆ

### åœºæ™¯ 2: æˆ‘è¦åš H5 å®¢æˆ·ç«¯å¼€å‘

**æ¨èé˜…è¯»é¡ºåº**:
1. `chat-history-timing-issue.md` - è§£å†³æ—¶åºé—®é¢˜
2. `web-ui-chat-implementation-analysis.md` - å‚è€ƒå®ç°
3. `embedding-web-ui-chat-solutions.md` - é›†æˆæ–¹æ¡ˆ

### åœºæ™¯ 3: æˆ‘è¦éƒ¨ç½²å¤šç”¨æˆ·äº‘ç«¯ç³»ç»Ÿ

**æ¨èé˜…è¯»é¡ºåº**:
1. `deployment-authentication-solutions-refined.md` - é€‰æ‹©æ–¹æ¡ˆ
2. `multi-user-isolation-solutions.md` - éš”ç¦»æ–¹æ¡ˆ
3. `api-token-usage-tracking-performance.md` - æ€§èƒ½è§„åˆ’
4. `sso-multi-user-implementation-guide.md` - å®æ–½æ–¹æ¡ˆ

### åœºæ™¯ 4: æˆ‘è¦äº†è§£å®‰å…¨æ€§å’Œè®¤è¯

**æ¨èé˜…è¯»é¡ºåº**:
1. `openclaw-native-auth-mechanisms.md` - åŸç”Ÿæœºåˆ¶
2. `oauth-password-auth-solution.md` - ç®€å•æ–¹æ¡ˆ
3. `oauth-device-hybrid-auth-solution.md` - é«˜å®‰å…¨æ–¹æ¡ˆ

### åœºæ™¯ 5: æˆ‘è¦åšæ¶æ„è®¾è®¡

**æ¨èé˜…è¯»é¡ºåº**:
1. `openclaw-sandbox-and-device-auth-details.md` - ç†è§£æ¶æ„
2. `deployment-authentication-solutions.md` - æ‰€æœ‰æ–¹æ¡ˆ
3. `multi-user-isolation-solutions.md` - éš”ç¦»æ–¹æ¡ˆ
4. `sso-multi-user-implementation-guide.md` - æœ€ç»ˆæ–¹æ¡ˆ

### åœºæ™¯ 6: æˆ‘è¦å®æ–½å®Œæ•´ç³»ç»Ÿ

**æ¨èé˜…è¯»é¡ºåº**:
1. `sso-multi-user-implementation-guide.md` - ä¸»æ–‡æ¡£
2. æ ¹æ®éœ€è¦å‚è€ƒå…¶ä»–å…·ä½“æŠ€æœ¯æ–‡æ¡£

---

## ğŸ”‘ æ ¸å¿ƒæ¦‚å¿µ

### sessionKeyï¼ˆä¼šè¯å¯†é’¥ï¼‰

**ä½œç”¨**: é€»è¾‘éš”ç¦»çš„å…³é”®

**æ ¼å¼**: `"user:{userId}"`

**ç”¨é€”**:
- æ¶ˆæ¯é˜Ÿåˆ—éš”ç¦»ï¼ˆSessionLaneï¼‰
- æ²™ç›’ç¯å¢ƒéš”ç¦»ï¼ˆSandboxContextï¼‰
- å†å²è®°å½•éš”ç¦»ï¼ˆTranscript æ–‡ä»¶ï¼‰

**ç¤ºä¾‹**:
```typescript
// ç”¨æˆ· Alice
sessionKey: "user:user_alice"

// ç”¨æˆ· Bob
sessionKey: "user:user_bob"
```

---

### workspaceDirï¼ˆå·¥ä½œåŒºç›®å½•ï¼‰

**ä½œç”¨**: æ–‡ä»¶ç³»ç»Ÿéš”ç¦»

**é»˜è®¤**: `~/.openclaw/workspace`

**å¤šç”¨æˆ·**: `/data/openclaw-users/{userId}/workspace`

**ç»“æ„**:
```
/data/openclaw-users/user_alice/
â”œâ”€â”€ workspace/          # Agent å·¥ä½œåŒº
â”‚   â”œâ”€â”€ IDENTITY.md    # Agent èº«ä»½å®šä¹‰
â”‚   â”œâ”€â”€ AGENTS.md      # å¯ç”¨ Agent åˆ—è¡¨
â”‚   â””â”€â”€ ...
â”œâ”€â”€ sessions/          # Session æ–‡ä»¶
â”œâ”€â”€ .openclaw/         # OpenClaw é…ç½®
â””â”€â”€ sandbox-workspace/ # æ²™ç›’å·¥ä½œåŒºï¼ˆå¯é€‰ï¼‰
```

---

### authProfileIdï¼ˆè®¤è¯é…ç½® IDï¼‰

**ä½œç”¨**: æ¯ä¸ªç”¨æˆ·ç‹¬ç«‹çš„ API Token

**æ ¼å¼**: `"user-{userId}-anthropic"`

**ç”¨é€”**:
- æ¯ä¸ªç”¨æˆ·ä½¿ç”¨è‡ªå·±çš„ API Key
- ç‹¬ç«‹è®¡è´¹å’Œé…é¢
- å¯é€‰åŠŸèƒ½ï¼ˆä¸æä¾›åˆ™ä½¿ç”¨é»˜è®¤ï¼‰

**é…ç½®ä½ç½®**:
- `~/.openclaw/profiles/{profileId}.yml`
- æˆ–æ•°æ®åº“åŠ å¯†å­˜å‚¨

---

### è®¾å¤‡é…å¯¹ï¼ˆDevice Pairingï¼‰

**ä½œç”¨**: è®¾å¤‡çº§è®¤è¯ï¼Œæ¯”å…±äº« Token å®‰å…¨

**æµç¨‹**:
1. è®¾å¤‡ç”Ÿæˆ Ed25519 å¯†é’¥å¯¹
2. å‘é€é…å¯¹è¯·æ±‚
3. ç”¨æˆ·åœ¨ Control UI æ‰¹å‡†
4. Gateway ç”Ÿæˆ deviceToken
5. åç»­ä½¿ç”¨ deviceToken è¿æ¥

**å­˜å‚¨**:
- `~/.openclaw/devices/paired.json`
- `~/.openclaw/devices/pending.json`

---

## ğŸ› ï¸ ç›¸å…³ä»£ç æ–‡ä»¶

### Gateway æ ¸å¿ƒæ–‡ä»¶

| æ–‡ä»¶ | ä½œç”¨ |
|------|------|
| `src/gateway/auth.ts` | è®¤è¯é€»è¾‘ï¼ˆToken/Password/Deviceï¼‰ |
| `src/gateway/device-auth.ts` | è®¾å¤‡è®¤è¯ payload æ„å»º |
| `src/gateway/server-methods/chat.ts` | Chat æ–¹æ³•å¤„ç† |
| `src/infra/device-identity.ts` | è®¾å¤‡èº«ä»½ç”Ÿæˆå’ŒéªŒè¯ |
| `src/infra/device-pairing.ts` | è®¾å¤‡é…å¯¹å’Œ deviceToken ç®¡ç† |
| `src/agents/sandbox/context.ts` | æ²™ç›’ä¸Šä¸‹æ–‡è§£æ |
| `src/agents/workspace.ts` | å·¥ä½œåŒºè§£æ |
| `src/agents/pi-embedded-runner/run.ts` | Agent æ‰§è¡Œå…¥å£ |

### H5 å®¢æˆ·ç«¯æ–‡ä»¶

| æ–‡ä»¶ | ä½œç”¨ |
|------|------|
| `src/canvas-host/app-h5/services/chat/ChatService.ts` | Chat æœåŠ¡ |
| `src/canvas-host/app-h5/hooks/useChat.ts` | React Hook |
| `src/canvas-host/app-h5/services/gateway/GatewayService.ts` | WebSocket æœåŠ¡ |

---

## ğŸ“Š å†³ç­–æ ‘

### å¦‚ä½•é€‰æ‹©è®¤è¯æ–¹æ¡ˆï¼Ÿ

```
éœ€è¦å¤šç”¨æˆ·å—ï¼Ÿ
â”œâ”€ å¦ â†’ ä½¿ç”¨ Password æ¨¡å¼æˆ–è®¾å¤‡é…å¯¹
â””â”€ æ˜¯ â†’ å·²æœ‰ OAuth ç³»ç»Ÿï¼Ÿ
    â”œâ”€ æ˜¯ â†’ OAuth + Passwordï¼ˆç®€å•ï¼‰
    â”‚    â””â”€ é«˜å®‰å…¨è¦æ±‚ï¼Ÿâ†’ OAuth + è®¾å¤‡ç­¾åï¼ˆå¤æ‚ï¼‰
    â””â”€ å¦ â†’ å®æ–½ OAuth 2.0 SSO
```

### å¦‚ä½•é€‰æ‹©éš”ç¦»æ–¹æ¡ˆï¼Ÿ

```
å¤šç”¨æˆ·å…±äº« Gatewayï¼Ÿ
â”œâ”€ å¦ â†’ æ¯ä¸ªç”¨æˆ·ç‹¬ç«‹ Gateway å®ä¾‹
â””â”€ æ˜¯ â†’ éš”ç¦»è¦æ±‚ï¼Ÿ
    â”œâ”€ æ–‡ä»¶çº§ â†’ ç‹¬ç«‹å·¥ä½œåŒºï¼ˆæ¨èï¼‰
    â”œâ”€ è¿›ç¨‹çº§ â†’ ç‹¬ç«‹å®¹å™¨ / Gateway å¤šå®ä¾‹
    â””â”€ é€»è¾‘çº§ â†’ æ•°æ®åº“è·¯ç”±ï¼ˆä¸æ¨èï¼‰
```

### æ˜¯å¦éœ€è¦ç‹¬ç«‹ API Tokenï¼Ÿ

```
éœ€è¦æŒ‰ç”¨æˆ·è®¡è´¹å—ï¼Ÿ
â”œâ”€ æ˜¯ â†’ ç‹¬ç«‹ API Token + ä½¿ç”¨è¿½è¸ª
â””â”€ å¦ â†’ ä½¿ç”¨ç³»ç»Ÿé»˜è®¤ API Key
    â””â”€ ä»éœ€è¿½è¸ªä½¿ç”¨ï¼Ÿâ†’ ä»…è®°å½•ä½¿ç”¨æ—¥å¿—
```

---

## ğŸ¯ å¸¸è§é—®é¢˜

### Q1: Agent æ˜¯ç‹¬ç«‹è¿›ç¨‹å—ï¼Ÿ

**A**: ä¸æ˜¯ã€‚Agent (pi-ai SDK) åµŒå…¥åœ¨ Gateway è¿›ç¨‹ä¸­ï¼Œä½†é€šè¿‡ `sessionKey` å®ç°é€»è¾‘éš”ç¦»ã€‚

### Q2: å¦‚ä½•ä¿è¯ç”¨æˆ·ä¹‹é—´å®Œå…¨éš”ç¦»ï¼Ÿ

**A**:
- **å·¥ä½œåŒºéš”ç¦»**: ç‹¬ç«‹ `workspaceDir`
- **æ¶ˆæ¯éš”ç¦»**: ç‹¬ç«‹ `sessionKey`
- **æ²™ç›’éš”ç¦»**: `resolveSandboxContext()` åŸºäº `sessionKey`
- **API Token**: å¯é€‰ç‹¬ç«‹ `authProfileId`

### Q3: Gateway èƒ½æ”¯æ’‘å¤šå°‘å¹¶å‘ç”¨æˆ·ï¼Ÿ

**A**: å•å®ä¾‹çº¦ 100-200 å¹¶å‘ç”¨æˆ·ã€‚é€šè¿‡è´Ÿè½½å‡è¡¡å¯æ°´å¹³æ‰©å±•åˆ° 300-600+ï¼ˆ3 å®ä¾‹ï¼‰ã€‚

### Q4: æœ¬åœ°ç¡¬ä»¶ç›’å­å¦‚ä½•æ¥å…¥ï¼Ÿ

**A**: é€šè¿‡ Tailscale éš§é“æˆ–ä¸€æ¬¡æ€§é…å¯¹ Tokenï¼Œå®ç°å…¬ç½‘è®¿é—®ã€‚

### Q5: å¦‚ä½•å®ç°æŒ‰ç”¨æˆ·è®¡è´¹ï¼Ÿ

**A**:
1. ä¸ºç”¨æˆ·åˆ†é…ç‹¬ç«‹ API Tokenï¼ˆå¯é€‰ï¼‰
2. è®°å½•æ¯æ¬¡ Chat çš„ Token ä½¿ç”¨
3. è®¡ç®—æˆæœ¬å¹¶å†™å…¥ `token_usage_logs`
4. å®šæœŸæ±‡æ€»è´¦å•

### Q6: history ä¸ºä»€ä¹ˆè·å–ä¸åˆ°æœ€æ–°æ¶ˆæ¯ï¼Ÿ

**A**: Gateway å¼‚æ­¥å†™å…¥ session æ–‡ä»¶ï¼ˆfinal äº‹ä»¶ä¹‹åï¼‰ã€‚è§£å†³æ–¹æ¡ˆï¼š
- ä½¿ç”¨ `payload.message`ï¼ˆæ¨èï¼‰
- æ·»åŠ  300-500ms å»¶è¿Ÿ
- ä¸è¯·æ±‚ historyï¼Œä¾èµ–æœ¬åœ°ç´¯ç§¯

---

## ğŸ“ ç‰ˆæœ¬å†å²

| æ–‡æ¡£ | åˆ›å»ºæ—¥æœŸ | æœ€åæ›´æ–° |
|------|---------|---------|
| chat-history-timing-issue.md | 2026-02-05 | 2026-02-05 |
| web-ui-chat-implementation-analysis.md | 2026-02-05 | 2026-02-05 |
| embedding-web-ui-chat-solutions.md | 2026-02-05 | 2026-02-05 |
| token-generation-mechanism.md | 2026-02-05 | 2026-02-05 |
| deployment-authentication-solutions.md | 2026-02-05 | 2026-02-05 |
| openclaw-sandbox-and-device-auth-details.md | 2026-02-05 | 2026-02-05 |
| deployment-authentication-solutions-refined.md | 2026-02-05 | 2026-02-05 |
| oauth-device-hybrid-auth-solution.md | 2026-02-05 | 2026-02-05 |
| openclaw-native-auth-mechanisms.md | 2026-02-05 | 2026-02-05 |
| oauth-password-auth-solution.md | 2026-02-05 | 2026-02-05 |
| multi-user-isolation-solutions.md | 2026-02-05 | 2026-02-05 |
| api-token-usage-tracking-performance.md | 2026-02-05 | 2026-02-05 |
| sso-multi-user-implementation-guide.md | 2026-02-05 | 2026-02-05 |
| **README.md (æœ¬æ–‡ä»¶)** | **2026-02-05** | **2026-02-05** |

---

## ğŸ“ è”ç³»ä¸åé¦ˆ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·ï¼š
1. æŸ¥é˜…ç›¸å…³æŠ€æœ¯æ–‡æ¡£
2. æŸ¥çœ‹ OpenClaw å®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.openclaw.ai
3. æäº¤ Issue åˆ° GitHub

---

**æ–‡æ¡£ä¸­å¿ƒç‰ˆæœ¬**: 1.0
**æœ€åæ›´æ–°**: 2026-02-05
**ç»´æŠ¤è€…**: OpenClaw A2UI Team
