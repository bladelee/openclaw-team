# OAuth 2.0 + è®¾å¤‡ç­¾åæ··åˆè®¤è¯æ–¹æ¡ˆ

## ä¸šåŠ¡åœºæ™¯

### ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç”¨æˆ·æµè§ˆå™¨ / H5                           â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    Web åº”ç”¨å‰ç«¯                             â”‚ â”‚
â”‚  â”‚  - åŠŸèƒ½ Aï¼šDashboard                                        â”‚ â”‚
â”‚  â”‚  - åŠŸèƒ½ Bï¼šAnalytics                                        â”‚ â”‚
â”‚  â”‚  - åŠŸèƒ½ Cï¼šOpenClaw Chat  â† éœ€è¦é¢å¤–å®‰å…¨ä¿æŠ¤                â”‚ â”‚
â”‚  â”‚  - åŠŸèƒ½ Dï¼šSettings                                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ OAuth 2.0 Login
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     OAuth 2.0 æä¾›å•†                            â”‚
â”‚                  (Auth0 / Okta / GitHub)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒé—®é¢˜

**ç–‘é—®**ï¼šæ—¢ç„¶ç”¨æˆ·å·²ç»é€šè¿‡ OAuth 2.0 ç™»å½•äº†ï¼Œè¿˜éœ€è¦è®¾å¤‡ç­¾åè®¤è¯å—ï¼Ÿ

**ç­”æ¡ˆ**ï¼š**æ˜¯çš„ï¼Œéœ€è¦ï¼åŸå› å¦‚ä¸‹ï¼š**

1. **OAuth Token ä¿æŠ¤çš„æ˜¯"ç”¨æˆ·èº«ä»½"ï¼Œè€Œä¸æ˜¯"è®¾å¤‡èº«ä»½"**
   - OAuth Token è¯æ˜"ä½ æ˜¯è°"ï¼ˆç”¨æˆ·ï¼‰
   - è®¾å¤‡ç­¾åè¯æ˜"ä½ ä»å“ªé‡Œæ¥"ï¼ˆè®¾å¤‡ï¼‰
   - ä¸¤è€…ç»“åˆæ‰èƒ½ç¡®ä¿å®Œæ•´çš„èº«ä»½éªŒè¯

2. **OAuth Token å¯èƒ½è¢«çªƒå–**
   - å¦‚æœåªä¾èµ– OAuth Tokenï¼Œä¸€æ—¦ Token æ³„éœ²ï¼Œæ”»å‡»è€…å¯ä»¥ä»ä»»ä½•è®¾å¤‡è®¿é—®
   - è®¾å¤‡ç­¾åé™åˆ¶äº†åªèƒ½ä»æ³¨å†Œè¿‡çš„è®¾å¤‡è®¿é—®
   - å³ä½¿ OAuth Token è¢«çªƒå–ï¼Œæ”»å‡»è€…ä¹Ÿæ— æ³•ä»æœªæ³¨å†Œè®¾å¤‡è®¿é—®

3. **OpenClaw åŠŸèƒ½çš„ç‰¹æ®Šæ€§**
   - OpenClaw å…è®¸æ‰§è¡Œå·¥å…·ã€è®¿é—®æ–‡ä»¶ç³»ç»Ÿç­‰æ•æ„Ÿæ“ä½œ
   - æ¯”å…¶ä»–åŠŸèƒ½ï¼ˆDashboardã€Analyticsï¼‰éœ€è¦æ›´é«˜çš„å®‰å…¨çº§åˆ«
   - è®¾å¤‡ç­¾åæä¾›äº†é¢å¤–çš„å®‰å…¨å±‚

---

## æ··åˆè®¤è¯æ¶æ„

### åŒé‡è®¤è¯æ¨¡å‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       è®¤è¯å±‚æ¬¡                                   â”‚
â”‚                                                                  â”‚
â”‚  Layer 1: OAuth 2.0ï¼ˆç”¨æˆ·èº«ä»½è®¤è¯ï¼‰                              â”‚
â”‚  â”œâ”€ è¯æ˜"ä½ æ˜¯è°"ï¼ˆuser_id, emailï¼‰                               â”‚
â”‚  â”œâ”€ ç”± OAuth æä¾›å•†ç®¡ç†                                         â”‚
â”‚  â””â”€ ç”¨äºæ‰€æœ‰åŠŸèƒ½çš„è®¿é—®æ§åˆ¶                                       â”‚
â”‚                                                                  â”‚
â”‚  Layer 2: è®¾å¤‡ç­¾åè®¤è¯ï¼ˆè®¾å¤‡èº«ä»½è®¤è¯ï¼‰                            â”‚
â”‚  â”œâ”€ è¯æ˜"ä½ ä»å“ªé‡Œæ¥"ï¼ˆdevice_id, ç­¾åï¼‰                          â”‚
â”‚  â”œâ”€ ç”±ç³»ç»Ÿè‡ªå·±ç®¡ç†                                              â”‚
â”‚  â””â”€ ä»…ç”¨äºæ•æ„ŸåŠŸèƒ½ï¼ˆOpenClawï¼‰                                   â”‚
â”‚                                                                  â”‚
â”‚  Layer 3: ä¼šè¯éš”ç¦»ï¼ˆç”¨æˆ·ä¼šè¯éš”ç¦»ï¼‰                                â”‚
â”‚  â”œâ”€ æ¯ä¸ªç”¨æˆ·ç‹¬ç«‹ sessionKey                                      â”‚
â”‚  â”œâ”€ æ¶ˆæ¯å†å²éš”ç¦»                                                â”‚
â”‚  â””â”€ Agent é…ç½®éš”ç¦»                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è®¤è¯æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 1: ç”¨æˆ·ç™»å½•ç³»ç»Ÿ                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  1.1 ç”¨æˆ·ç‚¹å‡»"ç™»å½•"                                         â”‚ â”‚
â”‚  â”‚  1.2 é‡å®šå‘åˆ° OAuth æä¾›å•†                                  â”‚ â”‚
â”‚  â”‚  1.3 ç”¨æˆ·æˆæƒ                                               â”‚ â”‚
â”‚  â”‚  1.4 å›è°ƒåˆ°åº”ç”¨ï¼Œè·å– OAuth Token                           â”‚ â”‚
â”‚  â”‚  1.5 ä¿å­˜ Token åˆ° localStorage                            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â”‚                                  â”‚
â”‚                              â–¼                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  æ­¥éª¤ 2: è®¿é—®æ™®é€šåŠŸèƒ½ï¼ˆæ— éœ€è®¾å¤‡è®¤è¯ï¼‰                        â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚  - Dashboard                                           â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  - Analytics                                          â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  - Settings                                           â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                        â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  è®¤è¯æ–¹å¼ï¼šä»… OAuth Token                              â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  API è¯·æ±‚ï¼šAuthorization: Bearer {access_token}       â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â”‚                                  â”‚
â”‚                              â–¼                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  æ­¥éª¤ 3: é¦–æ¬¡è®¿é—® OpenClawï¼ˆéœ€è¦è®¾å¤‡æ³¨å†Œï¼‰                  â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚  3.1 æ£€æŸ¥æœ¬åœ°å­˜å‚¨æ˜¯å¦æœ‰è®¾å¤‡å‡­æ®                        â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  3.2 å¦‚æœæ²¡æœ‰ï¼Œè§¦å‘è®¾å¤‡æ³¨å†Œæµç¨‹                        â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  3.3 ç”Ÿæˆ Ed25519 å¯†é’¥å¯¹                              â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  3.4 å‘é€è®¾å¤‡æ³¨å†Œè¯·æ±‚ï¼ˆé™„å¸¦ OAuth Tokenï¼‰              â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  3.5 æœåŠ¡å™¨éªŒè¯ OAuth Token                           â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  3.6 æœåŠ¡å™¨å°†è®¾å¤‡ç»‘å®šåˆ°å½“å‰ç”¨æˆ·                        â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  3.7 è¿”å› deviceToken                                 â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  3.8 ä¿å­˜è®¾å¤‡å‡­æ®åˆ° localStorage                      â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â”‚                                  â”‚
â”‚                              â–¼                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  æ­¥éª¤ 4: åç»­è®¿é—® OpenClawï¼ˆåŒé‡è®¤è¯ï¼‰                      â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚  4.1 ä» localStorage åŠ è½½ OAuth Token                â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  4.2 ä» localStorage åŠ è½½è®¾å¤‡å‡­æ®                     â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  4.3 æ„å»ºè®¾å¤‡ç­¾å payload                             â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  4.4 ä½¿ç”¨ç§é’¥ç­¾å                                     â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  4.5 è¿æ¥åˆ° Gateway                                   â”‚ â”‚ â”‚
â”‚  â”‚  â”‚      - OAuth Tokenï¼ˆHTTP Headerï¼‰                     â”‚ â”‚ â”‚
â”‚  â”‚  â”‚      - è®¾å¤‡ç­¾åï¼ˆWebSocket æ¡æ‰‹ï¼‰                     â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  4.6 æœåŠ¡å™¨éªŒè¯ä¸¤è€…                                   â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  4.7 è¿æ¥æˆåŠŸ                                         â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å®ç°ç»†èŠ‚

### æ•°æ®åº“è¡¨è®¾è®¡

#### æ‰©å±•ç”¨æˆ·-è®¾å¤‡ç»‘å®šè¡¨

```sql
-- ç”¨æˆ·è¡¨ï¼ˆOAuth ç”¨æˆ·ä¿¡æ¯ï¼‰
CREATE TABLE oauth_users (
  user_id VARCHAR(255) PRIMARY KEY,  -- OAuth sub
  email VARCHAR(255) UNIQUE NOT NULL,
  name VARCHAR(255),
  provider VARCHAR(50),  -- auth0, okta, github
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- è®¾å¤‡è¡¨ï¼ˆè®¾å¤‡èº«ä»½ + ç­¾åï¼‰
CREATE TABLE devices (
  device_id VARCHAR(255) PRIMARY KEY,
  public_key TEXT NOT NULL,  -- Ed25519 å…¬é’¥
  device_token VARCHAR(255) UNIQUE NOT NULL,
  user_id VARCHAR(255) NOT NULL,  -- ç»‘å®šåˆ°çš„ç”¨æˆ·
  device_info JSON,  -- è®¾å¤‡ä¿¡æ¯ï¼ˆname, type, userAgentï¼‰
  registered_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  last_seen_at TIMESTAMP,
  status ENUM('active', 'revoked', 'lost') DEFAULT 'active',
  FOREIGN KEY (user_id) REFERENCES oauth_users(user_id) ON DELETE CASCADE,
  INDEX idx_user_id (user_id),
  INDEX idx_device_token (device_token)
);

-- ç”¨æˆ·å®ä¾‹æ˜ å°„è¡¨ï¼ˆç”¨æˆ· -> OpenClaw å®ä¾‹ï¼‰
CREATE TABLE user_instances (
  user_id VARCHAR(255) PRIMARY KEY,
  instance_type ENUM('cloud', 'local'),
  instance_id VARCHAR(255),
  gateway_url VARCHAR(512),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES oauth_users(user_id) ON DELETE CASCADE
);

-- äº‘ç«¯å®ä¾‹è¡¨
CREATE TABLE cloud_instances (
  instance_id VARCHAR(255) PRIMARY KEY,
  host VARCHAR(255),
  port INT,
  max_users INT DEFAULT 10,
  current_users INT DEFAULT 0,
  status ENUM('active', 'maintenance', 'offline') DEFAULT 'active'
);

-- æœ¬åœ°å®ä¾‹è¡¨
CREATE TABLE local_instances (
  instance_id VARCHAR(255) PRIMARY KEY,
  user_id VARCHAR(255) UNIQUE,
  tunnel_endpoint VARCHAR(512),
  last_heartbeat TIMESTAMP,
  online BOOLEAN DEFAULT FALSE,
  FOREIGN KEY (user_id) REFERENCES oauth_users(user_id) ON DELETE CASCADE
);
```

### å®¢æˆ·ç«¯å®ç°

#### OAuth ç™»å½•æµç¨‹

```typescript
// src/auth/oauth.ts

export class OAuthClient {
  private config = {
    domain: 'your-tenant.auth0.com',
    clientId: 'your-client-id',
    redirectUri: window.location.origin + '/callback',
    audience: 'https://your-api.example.com',
  };

  /**
   * å¯åŠ¨ OAuth ç™»å½•æµç¨‹
   */
  async login() {
    const params = new URLSearchParams({
      response_type: 'code',
      client_id: this.config.clientId,
      redirect_uri: this.config.redirectUri,
      scope: 'openid profile email',
      audience: this.config.audience,
      state: this.generateState(),
    });

    window.location.href = `https://${this.config.domain}/authorize?${params}`;
  }

  /**
   * å¤„ç† OAuth å›è°ƒ
   */
  async handleCallback() {
    const params = new URLSearchParams(window.location.search);
    const code = params.get('code');
    const state = params.get('state');

    // éªŒè¯ state
    if (!this.verifyState(state)) {
      throw new Error('Invalid state');
    }

    // äº¤æ¢ code for tokens
    const response = await fetch(`https://${this.config.domain}/oauth/token`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        grant_type: 'authorization_code',
        client_id: this.config.clientId,
        client_secret: 'your-client-secret',
        code,
        redirect_uri: this.config.redirectUri,
      }),
    });

    const tokens = await response.json();

    // ä¿å­˜ tokens
    localStorage.setItem('oauth_access_token', tokens.access_token);
    localStorage.setItem('oauth_id_token', tokens.id_token);
    localStorage.setItem('oauth_refresh_token', tokens.refresh_token);

    // è§£æç”¨æˆ·ä¿¡æ¯
    const userInfo = this.parseIdToken(tokens.id_token);

    return {
      accessToken: tokens.access_token,
      userId: userInfo.sub,
      email: userInfo.email,
      name: userInfo.name,
    };
  }

  /**
   * è·å–å½“å‰è®¿é—® Token
   */
  async getAccessToken(): Promise<string> {
    let token = localStorage.getItem('oauth_access_token');

    // æ£€æŸ¥ Token æ˜¯å¦è¿‡æœŸ
    if (this.isTokenExpired(token)) {
      token = await this.refreshAccessToken();
    }

    return token;
  }

  /**
   * åˆ·æ–°è®¿é—® Token
   */
  private async refreshAccessToken(): Promise<string> {
    const refreshToken = localStorage.getItem('oauth_refresh_token');

    const response = await fetch(`https://${this.config.domain}/oauth/token`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        grant_type: 'refresh_token',
        client_id: this.config.clientId,
        refresh_token: refreshToken,
      }),
    });

    const tokens = await response.json();

    localStorage.setItem('oauth_access_token', tokens.access_token);
    if (tokens.refresh_token) {
      localStorage.setItem('oauth_refresh_token', tokens.refresh_token);
    }

    return tokens.access_token;
  }

  /**
   * è§£æ Id Token
   */
  private parseIdToken(idToken: string) {
    const parts = idToken.split('.');
    const payload = JSON.parse(atob(parts[1]));
    return payload;
  }

  /**
   * æ£€æŸ¥ Token æ˜¯å¦è¿‡æœŸ
   */
  private isTokenExpired(token: string): boolean {
    const payload = this.parseIdToken(token);
    const now = Math.floor(Date.now() / 1000);
    return payload.exp < now;
  }

  /**
   * ç”Ÿæˆéšæœº stateï¼ˆé˜² CSRFï¼‰
   */
  private generateState(): string {
    return Array.from(crypto.getRandomValues(new Uint8Array(16)))
      .map(b => b.toString(16).padStart(2, '0'))
      .join('');
  }

  /**
   * éªŒè¯ state
   */
  private verifyState(state: string): boolean {
    const savedState = sessionStorage.getItem('oauth_state');
    sessionStorage.removeItem('oauth_state');
    return state === savedState;
  }

  /**
   * ç™»å‡º
   */
  async logout() {
    // æ¸…é™¤æœ¬åœ° Token
    localStorage.removeItem('oauth_access_token');
    localStorage.removeItem('oauth_id_token');
    localStorage.removeItem('oauth_refresh_token');

    // æ¸…é™¤è®¾å¤‡å‡­æ®
    localStorage.removeItem('openclaw_device_id');
    localStorage.removeItem('openclaw_private_key');
    localStorage.removeItem('openclaw_device_token');

    // é‡å®šå‘åˆ°ç™»å‡ºç«¯ç‚¹
    window.location.href = `https://${this.config.domain}/v2/logout?client_id=${this.config.clientId}&returnTo=${window.location.origin}`;
  }
}

export const oauthClient = new OAuthClient();
```

#### è®¾å¤‡ç®¡ç†ï¼ˆOpenClaw ä¸“ç”¨ï¼‰

```typescript
// src/openclaw/device-manager.ts

import { generateKeyPair, sign, deriveDeviceIdFromPublicKey } from '@/utils/device-auth';
import { oauthClient } from '@/auth/oauth';

export class DeviceManager {
  /**
   * æ£€æŸ¥æ˜¯å¦å·²æ³¨å†Œè®¾å¤‡
   */
  isDeviceRegistered(): boolean {
    return !!(
      localStorage.getItem('openclaw_device_id') &&
      localStorage.getItem('openclaw_private_key') &&
      localStorage.getItem('openclaw_device_token')
    );
  }

  /**
   * æ³¨å†Œæ–°è®¾å¤‡ï¼ˆéœ€è¦ OAuth Tokenï¼‰
   */
  async registerDevice(): Promise<{
    deviceId: string;
    deviceToken: string;
  }> {
    try {
      // 1. è·å– OAuth Tokenï¼ˆè¯æ˜ç”¨æˆ·èº«ä»½ï¼‰
      const oauthToken = await oauthClient.getAccessToken();

      // 2. ç”Ÿæˆè®¾å¤‡å¯†é’¥å¯¹
      const keyPair = await generateKeyPair();
      const deviceId = await deriveDeviceIdFromPublicKey(keyPair.publicKey);

      // 3. æ„å»ºè®¾å¤‡æ³¨å†Œè¯·æ±‚
      const registerRequest = {
        deviceId,
        publicKey: keyPair.publicKey,
        deviceInfo: {
          name: this.getDeviceName(),
          type: this.getDeviceType(),
          userAgent: navigator.userAgent,
        },
      };

      // 4. å‘é€æ³¨å†Œè¯·æ±‚ï¼ˆé™„å¸¦ OAuth Tokenï¼‰
      const response = await fetch('/api/openclaw/devices/register', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${oauthToken}`,
        },
        body: JSON.stringify(registerRequest),
      });

      if (!response.ok) {
        throw new Error('Device registration failed');
      }

      const result = await response.json();

      // 5. ä¿å­˜è®¾å¤‡å‡­æ®åˆ°æœ¬åœ°
      localStorage.setItem('openclaw_device_id', deviceId);
      localStorage.setItem('openclaw_private_key', keyPair.privateKey);
      localStorage.setItem('openclaw_device_token', result.deviceToken);

      return {
        deviceId,
        deviceToken: result.deviceToken,
      };
    } catch (error) {
      console.error('Device registration failed:', error);
      throw error;
    }
  }

  /**
   * è·å–è®¾å¤‡å‡­æ®
   */
  getDeviceCredentials(): {
    deviceId: string;
    privateKey: string;
    deviceToken: string;
  } | null {
    const deviceId = localStorage.getItem('openclaw_device_id');
    const privateKey = localStorage.getItem('openclaw_private_key');
    const deviceToken = localStorage.getItem('openclaw_device_token');

    if (!deviceId || !privateKey || !deviceToken) {
      return null;
    }

    return { deviceId, privateKey, deviceToken };
  }

  /**
   * æ„å»ºè®¾å¤‡è®¤è¯ payload
   */
  async buildDeviceAuthPayload(): Promise<{
    payload: string;
    signature: string;
  }> {
    const credentials = this.getDeviceCredentials();

    if (!credentials) {
      throw new Error('Device not registered');
    }

    const { deviceId, privateKey, deviceToken } = credentials;

    // æ„å»ºè®¤è¯ payloadï¼ˆv2ï¼‰
    const timestamp = Date.now();
    const nonce = crypto.randomUUID();

    const payload = [
      'v2',
      deviceId,
      'webchat-ui',
      'webchat',
      'operator',
      'operator.read,operator.write',
      timestamp,
      deviceToken,
      nonce,
    ].join('|');

    // ä½¿ç”¨ç§é’¥ç­¾å
    const signature = await sign(payload, privateKey);

    return { payload, signature };
  }

  /**
   * æ’¤é”€å½“å‰è®¾å¤‡
   */
  async revokeDevice(): Promise<void> {
    const oauthToken = await oauthClient.getAccessToken();
    const credentials = this.getDeviceCredentials();

    if (!credentials) {
      return;
    }

    await fetch('/api/openclaw/devices/revoke', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${oauthToken}`,
      },
      body: JSON.stringify({
        deviceId: credentials.deviceId,
      }),
    });

    // æ¸…é™¤æœ¬åœ°å‡­æ®
    localStorage.removeItem('openclaw_device_id');
    localStorage.removeItem('openclaw_private_key');
    localStorage.removeItem('openclaw_device_token');
  }

  /**
   * åˆ—å‡ºç”¨æˆ·çš„æ‰€æœ‰è®¾å¤‡
   */
  async listDevices(): Promise<Array<{
    deviceId: string;
    deviceInfo: any;
    lastSeenAt: number;
    status: string;
  }>> {
    const oauthToken = await oauthClient.getAccessToken();

    const response = await fetch('/api/openclaw/devices', {
      headers: {
        'Authorization': `Bearer ${oauthToken}`,
      },
    });

    if (!response.ok) {
      throw new Error('Failed to list devices');
    }

    return await response.json();
  }

  /**
   * è·å–è®¾å¤‡åç§°
   */
  private getDeviceName(): string {
    const userAgent = navigator.userAgent;

    if (/iPhone|iPad|iPod/.test(userAgent)) {
      return 'iPhone/iPad';
    } else if (/Android/.test(userAgent)) {
      return 'Android Device';
    } else if (/Mac/.test(userAgent)) {
      return 'Mac';
    } else if (/Windows/.test(userAgent)) {
      return 'Windows PC';
    } else if (/Linux/.test(userAgent)) {
      return 'Linux PC';
    } else {
      return 'Unknown Device';
    }
  }

  /**
   * è·å–è®¾å¤‡ç±»å‹
   */
  private getDeviceType(): 'mobile' | 'desktop' {
    const userAgent = navigator.userAgent;
    return /iPhone|iPad|iPod|Android/.test(userAgent) ? 'mobile' : 'desktop';
  }
}

export const deviceManager = new DeviceManager();
```

#### OpenClaw å®¢æˆ·ç«¯ï¼ˆåŒé‡è®¤è¯ï¼‰

```typescript
// src/openclaw/client.ts

import { GatewayBrowserClient } from '@/services/gateway';
import { oauthClient } from '@/auth/oauth';
import { deviceManager } from './device-manager';

export class OpenClawClient {
  private client: GatewayBrowserClient | null = null;
  private userId: string | null = null;
  private sessionKey: string | null = null;

  /**
   * è¿æ¥åˆ° OpenClaw Gateway
   */
  async connect(): Promise<void> {
    try {
      // æ­¥éª¤ 1: ç¡®ä¿ OAuth Token æœ‰æ•ˆ
      const oauthToken = await oauthClient.getAccessToken();
      this.userId = this.parseUserIdFromToken(oauthToken);

      // æ­¥éª¤ 2: æ£€æŸ¥è®¾å¤‡æ˜¯å¦å·²æ³¨å†Œ
      if (!deviceManager.isDeviceRegistered()) {
        // é¦–æ¬¡è®¿é—®ï¼šéœ€è¦æ³¨å†Œè®¾å¤‡
        console.log('[OpenClaw] Device not registered, registering...');
        await deviceManager.registerDevice();
      }

      // æ­¥éª¤ 3: æ„å»ºè®¾å¤‡è®¤è¯ payload
      const deviceAuth = await deviceManager.buildDeviceAuthPayload();

      // æ­¥éª¤ 4: è¿æ¥åˆ° Gatewayï¼ˆåŒé‡è®¤è¯ï¼‰
      this.client = new GatewayBrowserClient({
        url: 'wss://openclaw.example.com/ws',
        // OAuth Tokenï¼ˆé€šè¿‡ HTTP Header ä¼ é€’ï¼‰
        authToken: oauthToken,
        // è®¾å¤‡ç­¾åï¼ˆé€šè¿‡ WebSocket æ¡æ‰‹ä¼ é€’ï¼‰
        deviceAuth: deviceAuth,
      });

      await this.client.connect();

      // æ­¥éª¤ 5: è·å–ä¼šè¯ä¿¡æ¯
      const sessionInfo = await this.client.request('session.info');
      this.sessionKey = sessionInfo.sessionKey;

      console.log(`[OpenClaw] Connected as user ${this.userId}, session ${this.sessionKey}`);
    } catch (error) {
      console.error('[OpenClaw] Connection failed:', error);
      throw error;
    }
  }

  /**
   * å‘é€èŠå¤©æ¶ˆæ¯
   */
  async sendChatMessage(message: string) {
    if (!this.client || !this.sessionKey) {
      throw new Error('Not connected');
    }

    return await this.client.request('chat.send', {
      sessionKey: this.sessionKey,
      message,
    });
  }

  /**
   * æ–­å¼€è¿æ¥
   */
  async disconnect() {
    if (this.client) {
      await this.client.disconnect();
      this.client = null;
    }
  }

  /**
   * ä» OAuth Token è§£æç”¨æˆ· ID
   */
  private parseUserIdFromToken(token: string): string {
    const parts = token.split('.');
    const payload = JSON.parse(atob(parts[1]));
    return payload.sub;
  }
}

export const openclawClient = new OpenClawClient();
```

### æœåŠ¡å™¨ç«¯å®ç°

#### è®¾å¤‡æ³¨å†Œ API

```typescript
// API è·¯ç”±ï¼š/api/openclaw/devices/register

import express from 'express';
import { verifyOAuthToken } from '@/auth/oauth-validator';
import { generateDeviceToken } from '@/utils/tokens';

const router = express.Router();

/**
 * æ³¨å†Œè®¾å¤‡ï¼ˆéœ€è¦ OAuth Tokenï¼‰
 */
router.post('/register', async (req, res) => {
  try {
    // 1. éªŒè¯ OAuth Tokenï¼ˆæå–ç”¨æˆ·èº«ä»½ï¼‰
    const oauthToken = req.headers.authorization?.replace('Bearer ', '');
    const user = await verifyOAuthToken(oauthToken);

    if (!user) {
      return res.status(401).json({ error: 'Invalid OAuth token' });
    }

    const { deviceId, publicKey, deviceInfo } = req.body;

    // 2. æ£€æŸ¥è®¾å¤‡æ˜¯å¦å·²æ³¨å†Œ
    const existingDevice = await db.query(`
      SELECT * FROM devices WHERE device_id = ?
    `, [deviceId]);

    if (existingDevice.length > 0) {
      // è®¾å¤‡å·²å­˜åœ¨ï¼Œæ£€æŸ¥æ˜¯å¦å±äºå½“å‰ç”¨æˆ·
      if (existingDevice[0].user_id !== user.userId) {
        return res.status(400).json({ error: 'Device already registered to another user' });
      }

      // è®¾å¤‡å±äºå½“å‰ç”¨æˆ·ï¼Œæ›´æ–° deviceToken
      const newDeviceToken = generateDeviceToken();

      await db.query(`
        UPDATE devices
        SET device_token = ?, last_seen_at = ?, status = 'active'
        WHERE device_id = ?
      `, [newDeviceToken, Date.now(), deviceId]);

      return res.json({
        deviceId,
        deviceToken: newDeviceToken,
        message: 'Device re-registered successfully',
      });
    }

    // 3. æ£€æŸ¥ç”¨æˆ·è®¾å¤‡æ•°é‡é™åˆ¶
    const deviceCount = await db.query(`
      SELECT COUNT(*) as count FROM devices WHERE user_id = ? AND status = 'active'
    `, [user.userId]);

    if (deviceCount[0].count >= 5) {
      return res.status(400).json({ error: 'Maximum device limit reached (5 devices per user)' });
    }

    // 4. ç”Ÿæˆ deviceToken
    const deviceToken = generateDeviceToken();

    // 5. ä¿å­˜è®¾å¤‡è®°å½•
    await db.query(`
      INSERT INTO devices (device_id, public_key, device_token, user_id, device_info, last_seen_at)
      VALUES (?, ?, ?, ?, ?, ?)
    `, [deviceId, publicKey, deviceToken, user.userId, JSON.stringify(deviceInfo), Date.now()]);

    // 6. æ¸…é™¤ç”¨æˆ·å®ä¾‹ç¼“å­˜ï¼ˆå¦‚æœéœ€è¦é‡æ–°åˆ†é…ï¼‰
    await redis.del(`user:instance:${user.userId}`);

    console.log(`[DeviceRegistry] Device ${deviceId} registered to user ${user.userId}`);

    res.json({
      deviceId,
      deviceToken,
      message: 'Device registered successfully',
    });
  } catch (error) {
    console.error('Device registration failed:', error);
    res.status(500).json({ error: 'Registration failed' });
  }
});

/**
 * æ’¤é”€è®¾å¤‡ï¼ˆéœ€è¦ OAuth Tokenï¼‰
 */
router.post('/revoke', async (req, res) => {
  try {
    const oauthToken = req.headers.authorization?.replace('Bearer ', '');
    const user = await verifyOAuthToken(oauthToken);

    if (!user) {
      return res.status(401).json({ error: 'Unauthorized' });
    }

    const { deviceId } = req.body;

    // éªŒè¯è®¾å¤‡å±äºå½“å‰ç”¨æˆ·
    const device = await db.query(`
      SELECT * FROM devices WHERE device_id = ? AND user_id = ?
    `, [deviceId, user.userId]);

    if (device.length === 0) {
      return res.status(404).json({ error: 'Device not found' });
    }

    // æ ‡è®°ä¸ºå·²æ’¤é”€
    await db.query(`
      UPDATE devices SET status = 'revoked' WHERE device_id = ?
    `, [deviceId]);

    // æ¸…é™¤ç¼“å­˜
    await redis.del(`device:${deviceId}`);

    res.json({ success: true, message: 'Device revoked' });
  } catch (error) {
    console.error('Device revocation failed:', error);
    res.status(500).json({ error: 'Revocation failed' });
  }
});

/**
 * åˆ—å‡ºç”¨æˆ·çš„æ‰€æœ‰è®¾å¤‡ï¼ˆéœ€è¦ OAuth Tokenï¼‰
 */
router.get('/', async (req, res) => {
  try {
    const oauthToken = req.headers.authorization?.replace('Bearer ', '');
    const user = await verifyOAuthToken(oauthToken);

    if (!user) {
      return res.status(401).json({ error: 'Unauthorized' });
    }

    const devices = await db.query(`
      SELECT device_id, device_info, last_seen_at, status
      FROM devices
      WHERE user_id = ?
      ORDER BY last_seen_at DESC
    `, [user.userId]);

    res.json(devices);
  } catch (error) {
    console.error('List devices failed:', error);
    res.status(500).json({ error: 'Failed to list devices' });
  }
});

export default router;
```

#### Gateway è®¤è¯ä¸­é—´ä»¶ï¼ˆåŒé‡éªŒè¯ï¼‰

```typescript
// Gateway ä¸­é—´ä»¶ï¼šåŒé‡è®¤è¯éªŒè¯

import { verifyDeviceSignature } from '@/infra/device-identity';
import { parseDeviceAuthPayload } from '@/gateway/device-auth';
import { verifyOAuthToken } from '@/auth/oauth-validator';

interface AuthResult {
  success: boolean;
  userId?: string;
  deviceId?: string;
  instanceType?: 'cloud' | 'local';
  instanceId?: string;
  sessionKey?: string;
  error?: string;
}

/**
 * åŒé‡è®¤è¯éªŒè¯
 * 1. OAuth Tokenï¼ˆç”¨æˆ·èº«ä»½ï¼‰
 * 2. è®¾å¤‡ç­¾åï¼ˆè®¾å¤‡èº«ä»½ï¼‰
 */
export async function verifyHybridAuth(
  oauthToken: string,
  deviceAuthPayload: string,
  deviceSignature: string
): Promise<AuthResult> {
  try {
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // æ­¥éª¤ 1: éªŒè¯ OAuth Tokenï¼ˆç”¨æˆ·èº«ä»½ï¼‰
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

    const user = await verifyOAuthToken(oauthToken);

    if (!user) {
      return { success: false, error: 'Invalid OAuth token' };
    }

    const userId = user.userId;

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // æ­¥éª¤ 2: è§£æè®¾å¤‡è®¤è¯ payload
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

    const auth = parseDeviceAuthPayload(deviceAuthPayload);

    if (auth.version !== 2) {
      return { success: false, error: 'Unsupported auth version' };
    }

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // æ­¥éª¤ 3: æŸ¥è¯¢è®¾å¤‡è®°å½•
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

    const deviceKey = `device:${auth.deviceId}`;
    const deviceRecord = await redis.get(deviceKey);

    if (!deviceRecord) {
      // Redis æœªå‘½ä¸­ï¼Œä»æ•°æ®åº“æŸ¥è¯¢
      const dbResult = await db.query(`
        SELECT * FROM devices WHERE device_id = ?
      `, [auth.deviceId]);

      if (dbResult.length === 0) {
        return { success: false, error: 'Device not registered' };
      }

      const device = dbResult[0];

      // ç¼“å­˜åˆ° Redis
      await redis.setex(deviceKey, 30 * 24 * 60 * 60, JSON.stringify(device));
    }

    const device = JSON.parse(deviceRecord);

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // æ­¥éª¤ 4: éªŒè¯è®¾å¤‡å½’å±
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

    // âš ï¸ å…³é”®å®‰å…¨æ£€æŸ¥ï¼šè®¾å¤‡å¿…é¡»å±äºå½“å‰ç”¨æˆ·
    if (device.user_id !== userId) {
      console.warn(`[Security] Device ${auth.deviceId} does not belong to user ${userId}`);
      return { success: false, error: 'Device does not belong to user' };
    }

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // æ­¥éª¤ 5: éªŒè¯è®¾å¤‡çŠ¶æ€
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

    if (device.status !== 'active') {
      return { success: false, error: 'Device inactive or revoked' };
    }

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // æ­¥éª¤ 6: éªŒè¯ deviceToken
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

    if (device.device_token !== auth.deviceToken) {
      return { success: false, error: 'Invalid device token' };
    }

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // æ­¥éª¤ 7: éªŒè¯ç­¾å
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

    const isValid = await verifyDeviceSignature(
      deviceAuthPayload,
      deviceSignature,
      device.publicKey
    );

    if (!isValid) {
      return { success: false, error: 'Invalid signature' };
    }

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // æ­¥éª¤ 8: æ£€æŸ¥ nonce é˜²é‡æ”¾æ”»å‡»
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

    const nonceKey = `nonce:${auth.nonce}`;
    const nonceExists = await redis.exists(nonceKey);

    if (nonceExists) {
      console.warn(`[Security] Replay attack detected: nonce ${auth.nonce}`);
      return { success: false, error: 'Replay attack detected' };
    }

    await redis.setex(nonceKey, 300, '1');  // 5 åˆ†é’Ÿè¿‡æœŸ

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // æ­¥éª¤ 9: æ›´æ–°è®¾å¤‡æœ€åæ´»è·ƒæ—¶é—´
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

    device.last_seen_at = Date.now();
    await redis.setex(deviceKey, 30 * 24 * 60 * 60, JSON.stringify(device));

    // å¼‚æ­¥æ›´æ–°æ•°æ®åº“
    db.query(`
      UPDATE devices SET last_seen_at = ? WHERE device_id = ?
    `, [Date.now(), auth.deviceId]).catch(console.error);

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // æ­¥éª¤ 10: æŸ¥è¯¢ç”¨æˆ·å®ä¾‹æ˜ å°„
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

    const userInstance = await getUserInstance(userId);

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // æ­¥éª¤ 11: ç”Ÿæˆä¼šè¯ Keyï¼ˆç”¨æˆ·éš”ç¦»ï¼‰
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

    const sessionKey = `user:${userId}`;

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // è®¤è¯æˆåŠŸ
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

    console.log(`[Auth] User ${userId} connected from device ${auth.deviceId}`);

    return {
      success: true,
      userId,
      deviceId: auth.deviceId,
      instanceType: userInstance.type,
      instanceId: userInstance.instanceId,
      sessionKey,
    };
  } catch (error) {
    console.error('[Auth] Verification failed:', error);
    return { success: false, error: 'Verification error' };
  }
}
```

#### OAuth Token éªŒè¯

```typescript
// src/auth/oauth-validator.ts

import jwt from 'jsonwebtoken';
import jwksClient from 'jwks-rsa';

// åˆ›å»º JWKS å®¢æˆ·ç«¯ï¼ˆç”¨äºéªŒè¯ RS256 ç­¾åï¼‰
const jwks = jwksClient({
  jwksUri: 'https://your-tenant.auth0.com/.well-known/jwks.json',
  cache: true,
  rateLimit: true,
});

/**
 * éªŒè¯ OAuth Token
 */
export async function verifyOAuthToken(token: string): Promise<{
  userId: string;
  email: string;
  name: string;
} | null> {
  try {
    // è§£ç  JWTï¼ˆä¸éªŒè¯ç­¾åï¼Œå…ˆè·å– headerï¼‰
    const decoded = jwt.decode(token, { complete: true });

    if (!decoded) {
      return null;
    }

    // è·å–ç­¾åå¯†é’¥
    const key = await jwks.getSigningKey(decoded.header.kid);
    const signingKey = key.getPublicKey();

    // éªŒè¯ JWT
    const verified = jwt.verify(token, signingKey, {
      audience: 'https://your-api.example.com',
      issuer: 'https://your-tenant.auth0.com/',
      algorithms: ['RS256'],
    });

    if (!verified) {
      return null;
    }

    // æå–ç”¨æˆ·ä¿¡æ¯
    return {
      userId: verified.sub,
      email: verified.email,
      name: verified.name,
    };
  } catch (error) {
    console.error('[OAuth] Token verification failed:', error);
    return null;
  }
}
```

---

## å®‰å…¨æ€§åˆ†æ

### æ”»å‡»åœºæ™¯é˜²æŠ¤

| æ”»å‡»åœºæ™¯ | OAuth Only | OAuth + è®¾å¤‡ç­¾å | é˜²æŠ¤æ•ˆæœ |
|---------|------------|------------------|----------|
| **OAuth Token æ³„éœ²** | âŒ æ”»å‡»è€…å¯ä»¥ä»ä»»ä½•è®¾å¤‡è®¿é—® | âœ… æ”»å‡»è€…æ— æ³•ä»æœªæ³¨å†Œè®¾å¤‡è®¿é—® | âœ… æœ‰æ•ˆé˜²æŠ¤ |
| **è®¾å¤‡ç§é’¥æ³„éœ²** | N/A | âš ï¸ å¯ä»¥ä»è¯¥è®¾å¤‡è®¿é—®ï¼Œä½†éœ€è¦ OAuth Token | âš ï¸ éƒ¨åˆ†é˜²æŠ¤ |
| **ä¸­é—´äººæ”»å‡»** | âš ï¸ HTTPS å¯é˜²æŠ¤ï¼Œä½†æ— æ³•éªŒè¯è®¾å¤‡ | âœ… HTTPS + è®¾å¤‡ç­¾ååŒé‡éªŒè¯ | âœ… æœ‰æ•ˆé˜²æŠ¤ |
| **é‡æ”¾æ”»å‡»** | âš ï¸ OAuth Token æœ¬èº«æœ‰æœ‰æ•ˆæœŸ | âœ… nonce æœºåˆ¶é˜²é‡æ”¾ | âœ… æœ‰æ•ˆé˜²æŠ¤ |
| **è·¨ç«™è„šæœ¬æ”»å‡»** | âš ï¸ XSS å¯ä»¥çªƒå– Token | âš ï¸ XSS å¯ä»¥çªƒå–ä¸¤è€… | âš ï¸ éœ€è¦å…¶ä»–é˜²æŠ¤ |
| **ä¼šè¯åŠ«æŒ** | âŒ å®¹æ˜“åŠ«æŒ | âœ… éœ€è¦åŒæ—¶åŠ«æŒ OAuth + è®¾å¤‡å‡­æ® | âœ… æé«˜éš¾åº¦ |

### å®‰å…¨çº§åˆ«

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å®‰å…¨çº§åˆ«åˆ†å±‚                            â”‚
â”‚                                                              â”‚
â”‚  Level 1: OAuth Token Only                                  â”‚
â”‚  â”œâ”€ ç”¨æˆ·èº«ä»½éªŒè¯                                            â”‚
â”‚  â”œâ”€ HTTPS ä¼ è¾“åŠ å¯†                                          â”‚
â”‚  â””â”€ âœ… é€‚åˆæ™®é€šåŠŸèƒ½ï¼ˆDashboardã€Analyticsï¼‰                 â”‚
â”‚                                                              â”‚
â”‚  Level 2: OAuth Token + è®¾å¤‡ç­¾åï¼ˆæ¨èï¼‰                    â”‚
â”‚  â”œâ”€ ç”¨æˆ·èº«ä»½éªŒè¯ï¼ˆOAuthï¼‰                                   â”‚
â”‚  â”œâ”€ è®¾å¤‡èº«ä»½éªŒè¯ï¼ˆç­¾åï¼‰                                    â”‚
â”‚  â”œâ”€ åŒé‡è®¤è¯ï¼ˆç¼ºä¸€ä¸å¯ï¼‰                                    â”‚
â”‚  â””â”€ âœ… é€‚åˆæ•æ„ŸåŠŸèƒ½ï¼ˆOpenClawï¼‰                             â”‚
â”‚                                                              â”‚
â”‚  Level 3: OAuth Token + è®¾å¤‡ç­¾å + ç”Ÿç‰©è¯†åˆ«                 â”‚
â”‚  â”œâ”€ ç”¨æˆ·èº«ä»½éªŒè¯ï¼ˆOAuthï¼‰                                   â”‚
â”‚  â”œâ”€ è®¾å¤‡èº«ä»½éªŒè¯ï¼ˆç­¾åï¼‰                                    â”‚
â”‚  â”œâ”€ ç”Ÿç‰©è¯†åˆ«ï¼ˆæŒ‡çº¹ã€Face IDï¼‰                               â”‚
â”‚  â””â”€ âœ… é€‚åˆæé«˜å®‰å…¨è¦æ±‚åœºæ™¯                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ç”¨æˆ·ç•Œé¢æµç¨‹

### é¦–æ¬¡è®¿é—® OpenClaw

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·ç‚¹å‡»"OpenClaw Chat"                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ£€æŸ¥è®¾å¤‡æ˜¯å¦å·²æ³¨å†Œ                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                         â”‚
        â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å·²æ³¨å†Œ          â”‚    â”‚  æœªæ³¨å†Œ          â”‚
â”‚  ç›´æ¥è¿æ¥        â”‚    â”‚  æ˜¾ç¤ºæ³¨å†Œå¯¹è¯æ¡†   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚  è®¾å¤‡æ³¨å†Œå¯¹è¯æ¡†             â”‚
                   â”‚                            â”‚
                   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                   â”‚  â”‚ æ£€æµ‹åˆ°æ–°è®¾å¤‡          â”‚ â”‚
                   â”‚  â”‚                      â”‚ â”‚
                   â”‚  â”‚ è®¾å¤‡: iPhone 15 Pro   â”‚ â”‚
                   â”‚  â”‚ ç±»å‹: mobile          â”‚ â”‚
                   â”‚  â”‚                      â”‚ â”‚
                   â”‚  â”‚ [æ³¨å†Œè®¾å¤‡] [å–æ¶ˆ]     â”‚ â”‚
                   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                    ç”¨æˆ·ç‚¹å‡»"æ³¨å†Œè®¾å¤‡"
                                  â”‚
                                  â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚  åå°æ‰§è¡Œ                  â”‚
                   â”‚  1. ç”Ÿæˆå¯†é’¥å¯¹            â”‚
                   â”‚  2. å‘é€æ³¨å†Œè¯·æ±‚          â”‚
                   â”‚  3. ä¿å­˜å‡­æ®              â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚  æ³¨å†ŒæˆåŠŸæç¤º              â”‚
                   â”‚                            â”‚
                   â”‚  âœ… è®¾å¤‡å·²æˆåŠŸæ³¨å†Œ         â”‚
                   â”‚                            â”‚
                   â”‚  è®¾å¤‡ ID: dev_abc123       â”‚
                   â”‚  æ³¨å†Œæ—¶é—´: 2025-02-05     â”‚
                   â”‚                            â”‚
                   â”‚  [è¿›å…¥ OpenClaw]           â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è®¾å¤‡ç®¡ç†ç•Œé¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è®¾å¤‡ç®¡ç†                                                    â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  å½“å‰è®¾å¤‡                                              â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ ğŸ“± iPhone 15 Pro (æœ¬è®¾å¤‡)                      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    æœ€åæ´»è·ƒ: åˆšæ‰                               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    çŠ¶æ€: âœ… æ´»è·ƒ                                â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    [æ’¤é”€æ­¤è®¾å¤‡]                                 â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                        â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ ğŸ’» MacBook Pro                                  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    æœ€åæ´»è·ƒ: 2 å°æ—¶å‰                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    çŠ¶æ€: âœ… æ´»è·ƒ                                â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    [æ’¤é”€æ­¤è®¾å¤‡]                                 â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                        â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ ğŸ–¥ï¸ Windows PC                                   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    æœ€åæ´»è·ƒ: 1 å¤©å‰                             â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    çŠ¶æ€: âš ï¸ ç¦»çº¿                                â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    [æ’¤é”€æ­¤è®¾å¤‡]                                 â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                        â”‚  â”‚
â”‚  â”‚  å·²æ³¨å†Œè®¾å¤‡: 3/5                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                              â”‚
â”‚  [æ³¨å†Œæ–°è®¾å¤‡] [å…³é—­]                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ–¹æ¡ˆæ€»ç»“

### æ··åˆè®¤è¯çš„ä¼˜åŠ¿

1. **ç”¨æˆ·èº«ä»½**ï¼šOAuth 2.0 æä¾›
   - æ ‡å‡†åŒ–è®¤è¯
   - æ”¯æŒå¤šç§ç™»å½•æ–¹å¼
   - é›†ä¸­ç”¨æˆ·ç®¡ç†
   - SSO æ”¯æŒ

2. **è®¾å¤‡èº«ä»½**ï¼šè®¾å¤‡ç­¾åè®¤è¯æä¾›
   - ç»‘å®šåˆ°å…·ä½“è®¾å¤‡
   - å¯æ’¤é”€å•ä¸ªè®¾å¤‡
   - é˜²æ­¢ Token æ³„éœ²åçš„æ»¥ç”¨
   - è®¾å¤‡æ•°é‡é™åˆ¶

3. **å®Œå…¨éš”ç¦»**ï¼šsessionKey æœºåˆ¶
   - æ¯ä¸ªç”¨æˆ·ç‹¬ç«‹ä¼šè¯
   - æ¶ˆæ¯å†å²éš”ç¦»
   - Agent é…ç½®éš”ç¦»

### é€‚ç”¨åœºæ™¯

- âœ… ç³»ç»Ÿæœ‰å¤šä¸ªåŠŸèƒ½ï¼Œç”¨æˆ·å¿…é¡»ç™»å½•
- âœ… OpenClaw æ˜¯æ•æ„ŸåŠŸèƒ½ï¼Œéœ€è¦é¢å¤–ä¿æŠ¤
- âœ… éœ€è¦é˜²æ­¢ OAuth Token æ³„éœ²åçš„æ»¥ç”¨
- âœ… éœ€è¦ç®¡ç†ç”¨æˆ·çš„è®¿é—®è®¾å¤‡

### å®æ–½å»ºè®®

1. **æ™®é€šåŠŸèƒ½**ï¼šä»…ä½¿ç”¨ OAuth Token è®¤è¯
   - Dashboardã€Analyticsã€Settings ç­‰

2. **æ•æ„ŸåŠŸèƒ½**ï¼šOAuth Token + è®¾å¤‡ç­¾ååŒé‡è®¤è¯
   - OpenClaw Chat
   - æ–‡ä»¶ç®¡ç†
   - ç³»ç»Ÿé…ç½®

3. **è®¾å¤‡ç®¡ç†**ï¼š
   - æ¯ä¸ªç”¨æˆ·æœ€å¤š 5 ä¸ªè®¾å¤‡
   - æ”¯æŒæ’¤é”€è®¾å¤‡
   - è®¾å¤‡åˆ—è¡¨å±•ç¤º

4. **ç”¨æˆ·ä½“éªŒ**ï¼š
   - é¦–æ¬¡è®¿é—®è‡ªåŠ¨æç¤ºæ³¨å†Œè®¾å¤‡
   - åç»­è®¿é—®è‡ªåŠ¨è¿æ¥
   - æ’¤é”€è®¾å¤‡åéœ€è¦é‡æ–°æ³¨å†Œ

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼š1.0
**åˆ›å»ºæ—¥æœŸ**ï¼š2026-02-05
**æœ€åæ›´æ–°**ï¼š2026-02-05
